var testKeyboardEvent=new KeyboardEvent("keydown");if(!("key"in testKeyboardEvent)){var KEYCODES_TO_KEYS={3:"Cancel",6:"Help",8:"Backspace",9:"Tab",12:"Clear",13:"Enter",16:"Shift",17:"Control",18:"Alt",19:"Pause",20:"CapsLock",27:"Escape",28:"Convert",29:"NonConvert",30:"Accept",31:"ModeChange",32:" ",33:"PageUp",34:"PageDown",35:"End",36:"Home",37:"ArrowLeft",38:"ArrowUp",39:"ArrowRight",40:"ArrowDown",41:"Select",42:"Print",43:"Execute",44:"PrintScreen",45:"Insert",46:"Delete",48:["0",")"],49:["1","!"],50:["2","@"],51:["3","#"],52:["4","$"],53:["5","%"],54:["6","^"],55:["7","&"],56:["8","*"],57:["9","("],91:"OS",93:"ContextMenu",144:"NumLock",145:"ScrollLock",181:"VolumeMute",182:"VolumeDown",183:"VolumeUp",186:[";",":"],187:["=","+"],188:[",","<"],189:["-","_"],190:[".",">"],191:["/","?"],192:["`","~"],219:["[","{"],220:["\\","|"],221:["]","}"],222:["'",'"'],224:"Meta",225:"AltGraph",246:"Attn",247:"CrSel",248:"ExSel",249:"EraseEof",250:"Play",251:"ZoomOut"};var i;for(i=1;i<25;i++){KEYCODES_TO_KEYS[111+i]="F"+i}var letter="";for(i=65;i<91;i++){letter=String.fromCharCode(i);KEYCODES_TO_KEYS[i]=[letter.toLowerCase(),letter.toUpperCase()]}Object.defineProperty(KeyboardEvent.prototype,"key",{get:function(x){var key=KEYCODES_TO_KEYS[this.which||this.keyCode];if(Array.isArray(key)){key=key[+this.shiftKey]}return key}})}(function(global){"use strict";if(typeof module!=="undefined"&&module.exports&&!global["encoding-indexes"]){global["encoding-indexes"]=require("./encoding-indexes.js")["encoding-indexes"]}function inRange(a,min,max){return min<=a&&a<=max}function includes(array,item){return array.indexOf(item)!==-1}var floor=Math.floor;function ToDictionary(o){if(o===undefined)return{};if(o===Object(o))return o;throw TypeError("Could not convert argument to dictionary")}function stringToCodePoints(string){var s=String(string);var n=s.length;var i=0;var u=[];while(i<n){var c=s.charCodeAt(i);if(c<55296||c>57343){u.push(c)}else if(56320<=c&&c<=57343){u.push(65533)}else if(55296<=c&&c<=56319){if(i===n-1){u.push(65533)}else{var d=s.charCodeAt(i+1);if(56320<=d&&d<=57343){var a=c&1023;var b=d&1023;u.push(65536+(a<<10)+b);i+=1}else{u.push(65533)}}}i+=1}return u}function codePointsToString(code_points){var s="";for(var i=0;i<code_points.length;++i){var cp=code_points[i];if(cp<=65535){s+=String.fromCharCode(cp)}else{cp-=65536;s+=String.fromCharCode((cp>>10)+55296,(cp&1023)+56320)}}return s}function isASCIIByte(a){return 0<=a&&a<=127}var isASCIICodePoint=isASCIIByte;var end_of_stream=-1;function Stream(tokens){this.tokens=[].slice.call(tokens);this.tokens.reverse()}Stream.prototype={endOfStream:function(){return!this.tokens.length},read:function(){if(!this.tokens.length)return end_of_stream;return this.tokens.pop()},prepend:function(token){if(Array.isArray(token)){var tokens=token;while(tokens.length)this.tokens.push(tokens.pop())}else{this.tokens.push(token)}},push:function(token){if(Array.isArray(token)){var tokens=token;while(tokens.length)this.tokens.unshift(tokens.shift())}else{this.tokens.unshift(token)}}};var finished=-1;function decoderError(fatal,opt_code_point){if(fatal)throw TypeError("Decoder error");return opt_code_point||65533}function encoderError(code_point){throw TypeError("The code point "+code_point+" could not be encoded.")}function Decoder(){}Decoder.prototype={handler:function(stream,bite){}};function Encoder(){}Encoder.prototype={handler:function(stream,code_point){}};function getEncoding(label){label=String(label).trim().toLowerCase();if(Object.prototype.hasOwnProperty.call(label_to_encoding,label)){return label_to_encoding[label]}return null}var encodings=[{encodings:[{labels:["unicode-1-1-utf-8","utf-8","utf8"],name:"UTF-8"}],heading:"The Encoding"},{encodings:[{labels:["866","cp866","csibm866","ibm866"],name:"IBM866"},{labels:["csisolatin2","iso-8859-2","iso-ir-101","iso8859-2","iso88592","iso_8859-2","iso_8859-2:1987","l2","latin2"],name:"ISO-8859-2"},{labels:["csisolatin3","iso-8859-3","iso-ir-109","iso8859-3","iso88593","iso_8859-3","iso_8859-3:1988","l3","latin3"],name:"ISO-8859-3"},{labels:["csisolatin4","iso-8859-4","iso-ir-110","iso8859-4","iso88594","iso_8859-4","iso_8859-4:1988","l4","latin4"],name:"ISO-8859-4"},{labels:["csisolatincyrillic","cyrillic","iso-8859-5","iso-ir-144","iso8859-5","iso88595","iso_8859-5","iso_8859-5:1988"],name:"ISO-8859-5"},{labels:["arabic","asmo-708","csiso88596e","csiso88596i","csisolatinarabic","ecma-114","iso-8859-6","iso-8859-6-e","iso-8859-6-i","iso-ir-127","iso8859-6","iso88596","iso_8859-6","iso_8859-6:1987"],name:"ISO-8859-6"},{labels:["csisolatingreek","ecma-118","elot_928","greek","greek8","iso-8859-7","iso-ir-126","iso8859-7","iso88597","iso_8859-7","iso_8859-7:1987","sun_eu_greek"],name:"ISO-8859-7"},{labels:["csiso88598e","csisolatinhebrew","hebrew","iso-8859-8","iso-8859-8-e","iso-ir-138","iso8859-8","iso88598","iso_8859-8","iso_8859-8:1988","visual"],name:"ISO-8859-8"},{labels:["csiso88598i","iso-8859-8-i","logical"],name:"ISO-8859-8-I"},{labels:["csisolatin6","iso-8859-10","iso-ir-157","iso8859-10","iso885910","l6","latin6"],name:"ISO-8859-10"},{labels:["iso-8859-13","iso8859-13","iso885913"],name:"ISO-8859-13"},{labels:["iso-8859-14","iso8859-14","iso885914"],name:"ISO-8859-14"},{labels:["csisolatin9","iso-8859-15","iso8859-15","iso885915","iso_8859-15","l9"],name:"ISO-8859-15"},{labels:["iso-8859-16"],name:"ISO-8859-16"},{labels:["cskoi8r","koi","koi8","koi8-r","koi8_r"],name:"KOI8-R"},{labels:["koi8-ru","koi8-u"],name:"KOI8-U"},{labels:["csmacintosh","mac","macintosh","x-mac-roman"],name:"macintosh"},{labels:["dos-874","iso-8859-11","iso8859-11","iso885911","tis-620","windows-874"],name:"windows-874"},{labels:["cp1250","windows-1250","x-cp1250"],name:"windows-1250"},{labels:["cp1251","windows-1251","x-cp1251"],name:"windows-1251"},{labels:["ansi_x3.4-1968","ascii","cp1252","cp819","csisolatin1","ibm819","iso-8859-1","iso-ir-100","iso8859-1","iso88591","iso_8859-1","iso_8859-1:1987","l1","latin1","us-ascii","windows-1252","x-cp1252"],name:"windows-1252"},{labels:["cp1253","windows-1253","x-cp1253"],name:"windows-1253"},{labels:["cp1254","csisolatin5","iso-8859-9","iso-ir-148","iso8859-9","iso88599","iso_8859-9","iso_8859-9:1989","l5","latin5","windows-1254","x-cp1254"],name:"windows-1254"},{labels:["cp1255","windows-1255","x-cp1255"],name:"windows-1255"},{labels:["cp1256","windows-1256","x-cp1256"],name:"windows-1256"},{labels:["cp1257","windows-1257","x-cp1257"],name:"windows-1257"},{labels:["cp1258","windows-1258","x-cp1258"],name:"windows-1258"},{labels:["x-mac-cyrillic","x-mac-ukrainian"],name:"x-mac-cyrillic"}],heading:"Legacy single-byte encodings"},{encodings:[{labels:["chinese","csgb2312","csiso58gb231280","gb2312","gb_2312","gb_2312-80","gbk","iso-ir-58","x-gbk"],name:"GBK"},{labels:["gb18030"],name:"gb18030"}],heading:"Legacy multi-byte Chinese (simplified) encodings"},{encodings:[{labels:["big5","big5-hkscs","cn-big5","csbig5","x-x-big5"],name:"Big5"}],heading:"Legacy multi-byte Chinese (traditional) encodings"},{encodings:[{labels:["cseucpkdfmtjapanese","euc-jp","x-euc-jp"],name:"EUC-JP"},{labels:["csiso2022jp","iso-2022-jp"],name:"ISO-2022-JP"},{labels:["csshiftjis","ms932","ms_kanji","shift-jis","shift_jis","sjis","windows-31j","x-sjis"],name:"Shift_JIS"}],heading:"Legacy multi-byte Japanese encodings"},{encodings:[{labels:["cseuckr","csksc56011987","euc-kr","iso-ir-149","korean","ks_c_5601-1987","ks_c_5601-1989","ksc5601","ksc_5601","windows-949"],name:"EUC-KR"}],heading:"Legacy multi-byte Korean encodings"},{encodings:[{labels:["csiso2022kr","hz-gb-2312","iso-2022-cn","iso-2022-cn-ext","iso-2022-kr"],name:"replacement"},{labels:["utf-16be"],name:"UTF-16BE"},{labels:["utf-16","utf-16le"],name:"UTF-16LE"},{labels:["x-user-defined"],name:"x-user-defined"}],heading:"Legacy miscellaneous encodings"}];var label_to_encoding={};encodings.forEach(function(category){category.encodings.forEach(function(encoding){encoding.labels.forEach(function(label){label_to_encoding[label]=encoding})})});var encoders={};var decoders={};function indexCodePointFor(pointer,index){if(!index)return null;return index[pointer]||null}function indexPointerFor(code_point,index){var pointer=index.indexOf(code_point);return pointer===-1?null:pointer}function index(name){if(!("encoding-indexes"in global)){throw Error("Indexes missing."+" Did you forget to include encoding-indexes.js first?")}return global["encoding-indexes"][name]}function indexGB18030RangesCodePointFor(pointer){if(pointer>39419&&pointer<189e3||pointer>1237575)return null;if(pointer===7457)return 59335;var offset=0;var code_point_offset=0;var idx=index("gb18030-ranges");var i;for(i=0;i<idx.length;++i){var entry=idx[i];if(entry[0]<=pointer){offset=entry[0];code_point_offset=entry[1]}else{break}}return code_point_offset+pointer-offset}function indexGB18030RangesPointerFor(code_point){if(code_point===59335)return 7457;var offset=0;var pointer_offset=0;var idx=index("gb18030-ranges");var i;for(i=0;i<idx.length;++i){var entry=idx[i];if(entry[1]<=code_point){offset=entry[1];pointer_offset=entry[0]}else{break}}return pointer_offset+code_point-offset}function indexShiftJISPointerFor(code_point){shift_jis_index=shift_jis_index||index("jis0208").map(function(code_point,pointer){return inRange(pointer,8272,8835)?null:code_point});var index_=shift_jis_index;return index_.indexOf(code_point)}var shift_jis_index;function indexBig5PointerFor(code_point){big5_index_no_hkscs=big5_index_no_hkscs||index("big5").map(function(code_point,pointer){return pointer<(161-129)*157?null:code_point});var index_=big5_index_no_hkscs;if(code_point===9552||code_point===9566||code_point===9569||code_point===9578||code_point===21313||code_point===21317){return index_.lastIndexOf(code_point)}return indexPointerFor(code_point,index_)}var big5_index_no_hkscs;var DEFAULT_ENCODING="utf-8";function TextDecoder(label,options){if(!(this instanceof TextDecoder))throw TypeError("Called as a function. Did you forget 'new'?");label=label!==undefined?String(label):DEFAULT_ENCODING;options=ToDictionary(options);this._encoding=null;this._decoder=null;this._ignoreBOM=false;this._BOMseen=false;this._error_mode="replacement";this._do_not_flush=false;var encoding=getEncoding(label);if(encoding===null||encoding.name==="replacement")throw RangeError("Unknown encoding: "+label);if(!decoders[encoding.name]){throw Error("Decoder not present."+" Did you forget to include encoding-indexes.js first?")}var dec=this;dec._encoding=encoding;if(Boolean(options["fatal"]))dec._error_mode="fatal";if(Boolean(options["ignoreBOM"]))dec._ignoreBOM=true;if(!Object.defineProperty){this.encoding=dec._encoding.name.toLowerCase();this.fatal=dec._error_mode==="fatal";this.ignoreBOM=dec._ignoreBOM}return dec}if(Object.defineProperty){Object.defineProperty(TextDecoder.prototype,"encoding",{get:function(){return this._encoding.name.toLowerCase()}});Object.defineProperty(TextDecoder.prototype,"fatal",{get:function(){return this._error_mode==="fatal"}});Object.defineProperty(TextDecoder.prototype,"ignoreBOM",{get:function(){return this._ignoreBOM}})}TextDecoder.prototype.decode=function decode(input,options){var bytes;if(typeof input==="object"&&input instanceof ArrayBuffer){bytes=new Uint8Array(input)}else if(typeof input==="object"&&"buffer"in input&&input.buffer instanceof ArrayBuffer){bytes=new Uint8Array(input.buffer,input.byteOffset,input.byteLength)}else{bytes=new Uint8Array(0)}options=ToDictionary(options);if(!this._do_not_flush){this._decoder=decoders[this._encoding.name]({fatal:this._error_mode==="fatal"});this._BOMseen=false}this._do_not_flush=Boolean(options["stream"]);var input_stream=new Stream(bytes);var output=[];var result;while(true){var token=input_stream.read();if(token===end_of_stream)break;result=this._decoder.handler(input_stream,token);if(result===finished)break;if(result!==null){if(Array.isArray(result))output.push.apply(output,result);else output.push(result)}}if(!this._do_not_flush){do{result=this._decoder.handler(input_stream,input_stream.read());if(result===finished)break;if(result===null)continue;if(Array.isArray(result))output.push.apply(output,result);else output.push(result)}while(!input_stream.endOfStream());this._decoder=null}function serializeStream(stream){if(includes(["UTF-8","UTF-16LE","UTF-16BE"],this._encoding.name)&&!this._ignoreBOM&&!this._BOMseen){if(stream.length>0&&stream[0]===65279){this._BOMseen=true;stream.shift()}else if(stream.length>0){this._BOMseen=true}else{}}return codePointsToString(stream)}return serializeStream.call(this,output)};function TextEncoder(label,options){if(!(this instanceof TextEncoder))throw TypeError("Called as a function. Did you forget 'new'?");options=ToDictionary(options);this._encoding=null;this._encoder=null;this._do_not_flush=false;this._fatal=Boolean(options["fatal"])?"fatal":"replacement";var enc=this;if(Boolean(options["NONSTANDARD_allowLegacyEncoding"])){label=label!==undefined?String(label):DEFAULT_ENCODING;var encoding=getEncoding(label);if(encoding===null||encoding.name==="replacement")throw RangeError("Unknown encoding: "+label);if(!encoders[encoding.name]){throw Error("Encoder not present."+" Did you forget to include encoding-indexes.js first?")}enc._encoding=encoding}else{enc._encoding=getEncoding("utf-8");if(label!==undefined&&"console"in global){console.warn("TextEncoder constructor called with encoding label, "+"which is ignored.")}}if(!Object.defineProperty)this.encoding=enc._encoding.name.toLowerCase();return enc}if(Object.defineProperty){Object.defineProperty(TextEncoder.prototype,"encoding",{get:function(){return this._encoding.name.toLowerCase()}})}TextEncoder.prototype.encode=function encode(opt_string,options){opt_string=opt_string===undefined?"":String(opt_string);options=ToDictionary(options);if(!this._do_not_flush)this._encoder=encoders[this._encoding.name]({fatal:this._fatal==="fatal"});this._do_not_flush=Boolean(options["stream"]);var input=new Stream(stringToCodePoints(opt_string));var output=[];var result;while(true){var token=input.read();if(token===end_of_stream)break;result=this._encoder.handler(input,token);if(result===finished)break;if(Array.isArray(result))output.push.apply(output,result);else output.push(result)}if(!this._do_not_flush){while(true){result=this._encoder.handler(input,input.read());if(result===finished)break;if(Array.isArray(result))output.push.apply(output,result);else output.push(result)}this._encoder=null}return new Uint8Array(output)};function UTF8Decoder(options){var fatal=options.fatal;var utf8_code_point=0,utf8_bytes_seen=0,utf8_bytes_needed=0,utf8_lower_boundary=128,utf8_upper_boundary=191;this.handler=function(stream,bite){if(bite===end_of_stream&&utf8_bytes_needed!==0){utf8_bytes_needed=0;return decoderError(fatal)}if(bite===end_of_stream)return finished;if(utf8_bytes_needed===0){if(inRange(bite,0,127)){return bite}else if(inRange(bite,194,223)){utf8_bytes_needed=1;utf8_code_point=bite&31}else if(inRange(bite,224,239)){if(bite===224)utf8_lower_boundary=160;if(bite===237)utf8_upper_boundary=159;utf8_bytes_needed=2;utf8_code_point=bite&15}else if(inRange(bite,240,244)){if(bite===240)utf8_lower_boundary=144;if(bite===244)utf8_upper_boundary=143;utf8_bytes_needed=3;utf8_code_point=bite&7}else{return decoderError(fatal)}return null}if(!inRange(bite,utf8_lower_boundary,utf8_upper_boundary)){utf8_code_point=utf8_bytes_needed=utf8_bytes_seen=0;utf8_lower_boundary=128;utf8_upper_boundary=191;stream.prepend(bite);return decoderError(fatal)}utf8_lower_boundary=128;utf8_upper_boundary=191;utf8_code_point=utf8_code_point<<6|bite&63;utf8_bytes_seen+=1;if(utf8_bytes_seen!==utf8_bytes_needed)return null;var code_point=utf8_code_point;utf8_code_point=utf8_bytes_needed=utf8_bytes_seen=0;return code_point}}function UTF8Encoder(options){var fatal=options.fatal;this.handler=function(stream,code_point){if(code_point===end_of_stream)return finished;if(isASCIICodePoint(code_point))return code_point;var count,offset;if(inRange(code_point,128,2047)){count=1;offset=192}else if(inRange(code_point,2048,65535)){count=2;offset=224}else if(inRange(code_point,65536,1114111)){count=3;offset=240}var bytes=[(code_point>>6*count)+offset];while(count>0){var temp=code_point>>6*(count-1);bytes.push(128|temp&63);count-=1}return bytes}}encoders["UTF-8"]=function(options){return new UTF8Encoder(options)};decoders["UTF-8"]=function(options){return new UTF8Decoder(options)};function SingleByteDecoder(index,options){var fatal=options.fatal;this.handler=function(stream,bite){if(bite===end_of_stream)return finished;if(isASCIIByte(bite))return bite;var code_point=index[bite-128];if(code_point===null)return decoderError(fatal);return code_point}}function SingleByteEncoder(index,options){var fatal=options.fatal;this.handler=function(stream,code_point){if(code_point===end_of_stream)return finished;if(isASCIICodePoint(code_point))return code_point;var pointer=indexPointerFor(code_point,index);if(pointer===null)encoderError(code_point);return pointer+128}}(function(){if(!("encoding-indexes"in global))return;encodings.forEach(function(category){if(category.heading!=="Legacy single-byte encodings")return;category.encodings.forEach(function(encoding){var name=encoding.name;var idx=index(name.toLowerCase());decoders[name]=function(options){return new SingleByteDecoder(idx,options)};encoders[name]=function(options){return new SingleByteEncoder(idx,options)}})})})();decoders["GBK"]=function(options){return new GB18030Decoder(options)};encoders["GBK"]=function(options){return new GB18030Encoder(options,true)};function GB18030Decoder(options){var fatal=options.fatal;var gb18030_first=0,gb18030_second=0,gb18030_third=0;this.handler=function(stream,bite){if(bite===end_of_stream&&gb18030_first===0&&gb18030_second===0&&gb18030_third===0){return finished}if(bite===end_of_stream&&(gb18030_first!==0||gb18030_second!==0||gb18030_third!==0)){gb18030_first=0;gb18030_second=0;gb18030_third=0;decoderError(fatal)}var code_point;if(gb18030_third!==0){code_point=null;if(inRange(bite,48,57)){code_point=indexGB18030RangesCodePointFor((((gb18030_first-129)*10+gb18030_second-48)*126+gb18030_third-129)*10+bite-48)}var buffer=[gb18030_second,gb18030_third,bite];gb18030_first=0;gb18030_second=0;gb18030_third=0;if(code_point===null){stream.prepend(buffer);return decoderError(fatal)}return code_point}if(gb18030_second!==0){if(inRange(bite,129,254)){gb18030_third=bite;return null}stream.prepend([gb18030_second,bite]);gb18030_first=0;gb18030_second=0;return decoderError(fatal)}if(gb18030_first!==0){if(inRange(bite,48,57)){gb18030_second=bite;return null}var lead=gb18030_first;var pointer=null;gb18030_first=0;var offset=bite<127?64:65;if(inRange(bite,64,126)||inRange(bite,128,254))pointer=(lead-129)*190+(bite-offset);code_point=pointer===null?null:indexCodePointFor(pointer,index("gb18030"));if(code_point===null&&isASCIIByte(bite))stream.prepend(bite);if(code_point===null)return decoderError(fatal);return code_point}if(isASCIIByte(bite))return bite;if(bite===128)return 8364;if(inRange(bite,129,254)){gb18030_first=bite;return null}return decoderError(fatal)}}function GB18030Encoder(options,gbk_flag){var fatal=options.fatal;this.handler=function(stream,code_point){if(code_point===end_of_stream)return finished;if(isASCIICodePoint(code_point))return code_point;if(code_point===58853)return encoderError(code_point);if(gbk_flag&&code_point===8364)return 128;var pointer=indexPointerFor(code_point,index("gb18030"));if(pointer!==null){var lead=floor(pointer/190)+129;var trail=pointer%190;var offset=trail<63?64:65;return[lead,trail+offset]}if(gbk_flag)return encoderError(code_point);pointer=indexGB18030RangesPointerFor(code_point);var byte1=floor(pointer/10/126/10);pointer=pointer-byte1*10*126*10;var byte2=floor(pointer/10/126);pointer=pointer-byte2*10*126;var byte3=floor(pointer/10);var byte4=pointer-byte3*10;return[byte1+129,byte2+48,byte3+129,byte4+48]}}encoders["gb18030"]=function(options){return new GB18030Encoder(options)};decoders["gb18030"]=function(options){return new GB18030Decoder(options)};function Big5Decoder(options){var fatal=options.fatal;var Big5_lead=0;this.handler=function(stream,bite){if(bite===end_of_stream&&Big5_lead!==0){Big5_lead=0;return decoderError(fatal)}if(bite===end_of_stream&&Big5_lead===0)return finished;if(Big5_lead!==0){var lead=Big5_lead;var pointer=null;Big5_lead=0;var offset=bite<127?64:98;if(inRange(bite,64,126)||inRange(bite,161,254))pointer=(lead-129)*157+(bite-offset);switch(pointer){case 1133:return[202,772];case 1135:return[202,780];case 1164:return[234,772];case 1166:return[234,780]}var code_point=pointer===null?null:indexCodePointFor(pointer,index("big5"));if(code_point===null&&isASCIIByte(bite))stream.prepend(bite);if(code_point===null)return decoderError(fatal);return code_point}if(isASCIIByte(bite))return bite;if(inRange(bite,129,254)){Big5_lead=bite;return null}return decoderError(fatal)}}function Big5Encoder(options){var fatal=options.fatal;this.handler=function(stream,code_point){if(code_point===end_of_stream)return finished;if(isASCIICodePoint(code_point))return code_point;var pointer=indexBig5PointerFor(code_point);if(pointer===null)return encoderError(code_point);var lead=floor(pointer/157)+129;if(lead<161)return encoderError(code_point);var trail=pointer%157;var offset=trail<63?64:98;return[lead,trail+offset]}}encoders["Big5"]=function(options){return new Big5Encoder(options)};decoders["Big5"]=function(options){return new Big5Decoder(options)};function EUCJPDecoder(options){var fatal=options.fatal;var eucjp_jis0212_flag=false,eucjp_lead=0;this.handler=function(stream,bite){if(bite===end_of_stream&&eucjp_lead!==0){eucjp_lead=0;return decoderError(fatal)}if(bite===end_of_stream&&eucjp_lead===0)return finished;if(eucjp_lead===142&&inRange(bite,161,223)){eucjp_lead=0;return 65377-161+bite}if(eucjp_lead===143&&inRange(bite,161,254)){eucjp_jis0212_flag=true;eucjp_lead=bite;return null}if(eucjp_lead!==0){var lead=eucjp_lead;eucjp_lead=0;var code_point=null;if(inRange(lead,161,254)&&inRange(bite,161,254)){code_point=indexCodePointFor((lead-161)*94+(bite-161),index(!eucjp_jis0212_flag?"jis0208":"jis0212"))}eucjp_jis0212_flag=false;if(!inRange(bite,161,254))stream.prepend(bite);if(code_point===null)return decoderError(fatal);return code_point}if(isASCIIByte(bite))return bite;if(bite===142||bite===143||inRange(bite,161,254)){eucjp_lead=bite;return null}return decoderError(fatal)}}function EUCJPEncoder(options){var fatal=options.fatal;this.handler=function(stream,code_point){if(code_point===end_of_stream)return finished;if(isASCIICodePoint(code_point))return code_point;if(code_point===165)return 92;if(code_point===8254)return 126;if(inRange(code_point,65377,65439))return[142,code_point-65377+161];if(code_point===8722)code_point=65293;var pointer=indexPointerFor(code_point,index("jis0208"));if(pointer===null)return encoderError(code_point);var lead=floor(pointer/94)+161;var trail=pointer%94+161;return[lead,trail]}}encoders["EUC-JP"]=function(options){return new EUCJPEncoder(options)};decoders["EUC-JP"]=function(options){return new EUCJPDecoder(options)};function ISO2022JPDecoder(options){var fatal=options.fatal;var states={ASCII:0,Roman:1,Katakana:2,LeadByte:3,TrailByte:4,EscapeStart:5,Escape:6};var iso2022jp_decoder_state=states.ASCII,iso2022jp_decoder_output_state=states.ASCII,iso2022jp_lead=0,iso2022jp_output_flag=false;this.handler=function(stream,bite){switch(iso2022jp_decoder_state){default:case states.ASCII:if(bite===27){iso2022jp_decoder_state=states.EscapeStart;return null}if(inRange(bite,0,127)&&bite!==14&&bite!==15&&bite!==27){iso2022jp_output_flag=false;return bite}if(bite===end_of_stream){return finished}iso2022jp_output_flag=false;return decoderError(fatal);case states.Roman:if(bite===27){iso2022jp_decoder_state=states.EscapeStart;return null}if(bite===92){iso2022jp_output_flag=false;return 165}if(bite===126){iso2022jp_output_flag=false;return 8254}if(inRange(bite,0,127)&&bite!==14&&bite!==15&&bite!==27&&bite!==92&&bite!==126){iso2022jp_output_flag=false;return bite}if(bite===end_of_stream){return finished}iso2022jp_output_flag=false;return decoderError(fatal);case states.Katakana:if(bite===27){iso2022jp_decoder_state=states.EscapeStart;return null}if(inRange(bite,33,95)){iso2022jp_output_flag=false;return 65377-33+bite}if(bite===end_of_stream){return finished}iso2022jp_output_flag=false;return decoderError(fatal);case states.LeadByte:if(bite===27){iso2022jp_decoder_state=states.EscapeStart;return null}if(inRange(bite,33,126)){iso2022jp_output_flag=false;iso2022jp_lead=bite;iso2022jp_decoder_state=states.TrailByte;return null}if(bite===end_of_stream){return finished}iso2022jp_output_flag=false;return decoderError(fatal);case states.TrailByte:if(bite===27){iso2022jp_decoder_state=states.EscapeStart;return decoderError(fatal)}if(inRange(bite,33,126)){iso2022jp_decoder_state=states.LeadByte;var pointer=(iso2022jp_lead-33)*94+bite-33;var code_point=indexCodePointFor(pointer,index("jis0208"));if(code_point===null)return decoderError(fatal);return code_point}if(bite===end_of_stream){iso2022jp_decoder_state=states.LeadByte;stream.prepend(bite);return decoderError(fatal)}iso2022jp_decoder_state=states.LeadByte;return decoderError(fatal);case states.EscapeStart:if(bite===36||bite===40){iso2022jp_lead=bite;iso2022jp_decoder_state=states.Escape;return null}stream.prepend(bite);iso2022jp_output_flag=false;iso2022jp_decoder_state=iso2022jp_decoder_output_state;return decoderError(fatal);case states.Escape:var lead=iso2022jp_lead;iso2022jp_lead=0;var state=null;if(lead===40&&bite===66)state=states.ASCII;if(lead===40&&bite===74)state=states.Roman;if(lead===40&&bite===73)state=states.Katakana;if(lead===36&&(bite===64||bite===66))state=states.LeadByte;if(state!==null){iso2022jp_decoder_state=iso2022jp_decoder_state=state;var output_flag=iso2022jp_output_flag;iso2022jp_output_flag=true;return!output_flag?null:decoderError(fatal)}stream.prepend([lead,bite]);iso2022jp_output_flag=false;iso2022jp_decoder_state=iso2022jp_decoder_output_state;return decoderError(fatal)}}}function ISO2022JPEncoder(options){var fatal=options.fatal;var states={ASCII:0,Roman:1,jis0208:2};var iso2022jp_state=states.ASCII;this.handler=function(stream,code_point){if(code_point===end_of_stream&&iso2022jp_state!==states.ASCII){stream.prepend(code_point);iso2022jp_state=states.ASCII;return[27,40,66]}if(code_point===end_of_stream&&iso2022jp_state===states.ASCII)return finished;if((iso2022jp_state===states.ASCII||iso2022jp_state===states.Roman)&&(code_point===14||code_point===15||code_point===27)){return encoderError(65533)}if(iso2022jp_state===states.ASCII&&isASCIICodePoint(code_point))return code_point;if(iso2022jp_state===states.Roman&&(isASCIICodePoint(code_point)&&code_point!==92&&code_point!==126||(code_point==165||code_point==8254))){if(isASCIICodePoint(code_point))return code_point;if(code_point===165)return 92;if(code_point===8254)return 126}if(isASCIICodePoint(code_point)&&iso2022jp_state!==states.ASCII){stream.prepend(code_point);iso2022jp_state=states.ASCII;return[27,40,66]}if((code_point===165||code_point===8254)&&iso2022jp_state!==states.Roman){stream.prepend(code_point);iso2022jp_state=states.Roman;return[27,40,74]}if(code_point===8722)code_point=65293;var pointer=indexPointerFor(code_point,index("jis0208"));if(pointer===null)return encoderError(code_point);if(iso2022jp_state!==states.jis0208){stream.prepend(code_point);iso2022jp_state=states.jis0208;return[27,36,66]}var lead=floor(pointer/94)+33;var trail=pointer%94+33;return[lead,trail]}}encoders["ISO-2022-JP"]=function(options){return new ISO2022JPEncoder(options)};decoders["ISO-2022-JP"]=function(options){return new ISO2022JPDecoder(options)};function ShiftJISDecoder(options){var fatal=options.fatal;var Shift_JIS_lead=0;this.handler=function(stream,bite){if(bite===end_of_stream&&Shift_JIS_lead!==0){Shift_JIS_lead=0;return decoderError(fatal)}if(bite===end_of_stream&&Shift_JIS_lead===0)return finished;if(Shift_JIS_lead!==0){var lead=Shift_JIS_lead;var pointer=null;Shift_JIS_lead=0;var offset=bite<127?64:65;var lead_offset=lead<160?129:193;if(inRange(bite,64,126)||inRange(bite,128,252))pointer=(lead-lead_offset)*188+bite-offset;if(inRange(pointer,8836,10715))return 57344-8836+pointer;var code_point=pointer===null?null:indexCodePointFor(pointer,index("jis0208"));if(code_point===null&&isASCIIByte(bite))stream.prepend(bite);if(code_point===null)return decoderError(fatal);return code_point}if(isASCIIByte(bite)||bite===128)return bite;if(inRange(bite,161,223))return 65377-161+bite;if(inRange(bite,129,159)||inRange(bite,224,252)){Shift_JIS_lead=bite;return null}return decoderError(fatal)}}function ShiftJISEncoder(options){var fatal=options.fatal;this.handler=function(stream,code_point){if(code_point===end_of_stream)return finished;if(isASCIICodePoint(code_point)||code_point===128)return code_point;if(code_point===165)return 92;if(code_point===8254)return 126;if(inRange(code_point,65377,65439))return code_point-65377+161;if(code_point===8722)code_point=65293;var pointer=indexShiftJISPointerFor(code_point);if(pointer===null)return encoderError(code_point);var lead=floor(pointer/188);var lead_offset=lead<31?129:193;var trail=pointer%188;var offset=trail<63?64:65;return[lead+lead_offset,trail+offset]}}encoders["Shift_JIS"]=function(options){return new ShiftJISEncoder(options)};decoders["Shift_JIS"]=function(options){return new ShiftJISDecoder(options)};function EUCKRDecoder(options){var fatal=options.fatal;var euckr_lead=0;this.handler=function(stream,bite){if(bite===end_of_stream&&euckr_lead!==0){euckr_lead=0;return decoderError(fatal)}if(bite===end_of_stream&&euckr_lead===0)return finished;if(euckr_lead!==0){var lead=euckr_lead;var pointer=null;euckr_lead=0;if(inRange(bite,65,254))pointer=(lead-129)*190+(bite-65);var code_point=pointer===null?null:indexCodePointFor(pointer,index("euc-kr"));if(pointer===null&&isASCIIByte(bite))stream.prepend(bite);if(code_point===null)return decoderError(fatal);return code_point}if(isASCIIByte(bite))return bite;if(inRange(bite,129,254)){euckr_lead=bite;return null}return decoderError(fatal)}}function EUCKREncoder(options){var fatal=options.fatal;this.handler=function(stream,code_point){if(code_point===end_of_stream)return finished;if(isASCIICodePoint(code_point))return code_point;var pointer=indexPointerFor(code_point,index("euc-kr"));if(pointer===null)return encoderError(code_point);var lead=floor(pointer/190)+129;var trail=pointer%190+65;return[lead,trail]}}encoders["EUC-KR"]=function(options){return new EUCKREncoder(options)};decoders["EUC-KR"]=function(options){return new EUCKRDecoder(options)};function convertCodeUnitToBytes(code_unit,utf16be){var byte1=code_unit>>8;var byte2=code_unit&255;if(utf16be)return[byte1,byte2];return[byte2,byte1]}function UTF16Decoder(utf16_be,options){var fatal=options.fatal;var utf16_lead_byte=null,utf16_lead_surrogate=null;this.handler=function(stream,bite){if(bite===end_of_stream&&(utf16_lead_byte!==null||utf16_lead_surrogate!==null)){return decoderError(fatal)}if(bite===end_of_stream&&utf16_lead_byte===null&&utf16_lead_surrogate===null){return finished}if(utf16_lead_byte===null){utf16_lead_byte=bite;return null}var code_unit;if(utf16_be){code_unit=(utf16_lead_byte<<8)+bite}else{code_unit=(bite<<8)+utf16_lead_byte}utf16_lead_byte=null;if(utf16_lead_surrogate!==null){var lead_surrogate=utf16_lead_surrogate;utf16_lead_surrogate=null;if(inRange(code_unit,56320,57343)){return 65536+(lead_surrogate-55296)*1024+(code_unit-56320)}stream.prepend(convertCodeUnitToBytes(code_unit,utf16_be));return decoderError(fatal)}if(inRange(code_unit,55296,56319)){utf16_lead_surrogate=code_unit;return null}if(inRange(code_unit,56320,57343))return decoderError(fatal);return code_unit}}function UTF16Encoder(utf16_be,options){var fatal=options.fatal;this.handler=function(stream,code_point){if(code_point===end_of_stream)return finished;if(inRange(code_point,0,65535))return convertCodeUnitToBytes(code_point,utf16_be);
var lead=convertCodeUnitToBytes((code_point-65536>>10)+55296,utf16_be);var trail=convertCodeUnitToBytes((code_point-65536&1023)+56320,utf16_be);return lead.concat(trail)}}encoders["UTF-16BE"]=function(options){return new UTF16Encoder(true,options)};decoders["UTF-16BE"]=function(options){return new UTF16Decoder(true,options)};encoders["UTF-16LE"]=function(options){return new UTF16Encoder(false,options)};decoders["UTF-16LE"]=function(options){return new UTF16Decoder(false,options)};function XUserDefinedDecoder(options){var fatal=options.fatal;this.handler=function(stream,bite){if(bite===end_of_stream)return finished;if(isASCIIByte(bite))return bite;return 63360+bite-128}}function XUserDefinedEncoder(options){var fatal=options.fatal;this.handler=function(stream,code_point){if(code_point===end_of_stream)return finished;if(isASCIICodePoint(code_point))return code_point;if(inRange(code_point,63360,63487))return code_point-63360+128;return encoderError(code_point)}}encoders["x-user-defined"]=function(options){return new XUserDefinedEncoder(options)};decoders["x-user-defined"]=function(options){return new XUserDefinedDecoder(options)};if(!global["TextEncoder"])global["TextEncoder"]=TextEncoder;if(!global["TextDecoder"])global["TextDecoder"]=TextDecoder;if(typeof module!=="undefined"&&module.exports){module.exports={TextEncoder:global["TextEncoder"],TextDecoder:global["TextDecoder"],EncodingIndexes:global["encoding-indexes"]}}})(this||{});if(!Array.prototype.findIndex){Object.defineProperty(Array.prototype,"findIndex",{value:function(predicate){if(this==null){throw new TypeError('"this" is null or not defined')}var o=Object(this);var len=o.length>>>0;if(typeof predicate!=="function"){throw new TypeError("predicate must be a function")}var thisArg=arguments[1];var k=0;while(k<len){var kValue=o[k];if(predicate.call(thisArg,kValue,k,o)){return k}k++}return-1}})}if(!Array.prototype.find){Object.defineProperty(Array.prototype,"find",{value:function(predicate){if(this==null){throw new TypeError('"this" is null or not defined')}var o=Object(this);var len=o.length>>>0;if(typeof predicate!=="function"){throw new TypeError("predicate must be a function")}var thisArg=arguments[1];var k=0;while(k<len){var kValue=o[k];if(predicate.call(thisArg,kValue,k,o)){return kValue}k++}return undefined}})}var TokenStream=function(arr){this.data=arr||[];this.index=0};TokenStream.prototype.read=function(){if(this.data.length<=this.index)throw new Error("End of stream!");return this.data[this.index++]};TokenStream.prototype.ended=function(){return this.data.length<=this.index};var ByteReadStream=function(arrayBuffer){this.buffer=arrayBuffer;this.data=new Uint8Array(this.buffer);this.index=0};ByteReadStream.prototype.readUint=function(byteCount){if(this.data.length<this.index+byteCount)throw new Error("End of stream!");var ret=0;for(var i=0;i<byteCount;++i){var bytedata=this.data[this.index++];ret+=bytedata*Math.pow(2,i*8)}return ret};ByteReadStream.prototype.readUint8=function(){return this.readUint(1)};ByteReadStream.prototype.readUint16=function(){return this.readUint(2)};ByteReadStream.prototype.readUint32=function(){return this.readUint(4)};ByteReadStream.prototype.readUint64=function(){return this.readUint(8)};ByteReadStream.prototype.readInt=function(byteCount){if(this.data.length<this.index+byteCount)throw new Error("End of stream!");var neg=(this.data[this.index+byteCount-1]&128)!==0;var ret=0;for(var i=0;i<byteCount;++i){var bytedata=this.data[this.index++];if(neg){bytedata=~bytedata&255}ret+=bytedata*Math.pow(2,i*8)}if(neg){ret=-(ret+1)}return ret};ByteReadStream.prototype.readInt8=function(){return this.readInt(1)};ByteReadStream.prototype.readInt16=function(){return this.readInt(2)};ByteReadStream.prototype.readInt32=function(){return this.readInt(4)};ByteReadStream.prototype.readInt64=function(){return this.readInt(8)};ByteReadStream.prototype.readBool=function(){return this.readInt(1)!==0};ByteReadStream.prototype.readString=function(){var len=this.readUint(4);if(this.data.length<this.index+len)throw new Error("End of stream!");var tmp_buffer_view=new Uint8Array(this.buffer,this.index,len);this.index+=len;return new TextDecoder("utf-8").decode(tmp_buffer_view)};var ByteWriteStream=function(){this.buffer=new ArrayBuffer(8);this.data=new Uint8Array(this.buffer);this.index=0};ByteWriteStream.prototype.reserve=function(bytes){if(this.index+bytes>this.data.length){var new_buffer=new ArrayBuffer(Math.max(this.data.length*2,this.index+bytes));var new_data=new Uint8Array(new_buffer);for(var i=0;i<this.index;++i){new_data[i]=this.data[i]}this.buffer=new_buffer;this.data=new_data}};ByteWriteStream.prototype.writeUint=function(byteCount,value){this.reserve(byteCount);for(var i=0;i<byteCount;++i){this.data[this.index++]=value&255;value/=256}};ByteWriteStream.prototype.writeUint8=function(value){this.writeUint(1,value)};ByteWriteStream.prototype.writeUint16=function(value){this.writeUint(2,value)};ByteWriteStream.prototype.writeUint32=function(value){this.writeUint(4,value)};ByteWriteStream.prototype.writeUint64=function(value){this.writeUint(8,value)};ByteWriteStream.prototype.writeInt=function(byteCount,value){this.reserve(byteCount);var neg=value<0;if(neg){value=-(value+1)}for(var i=0;i<byteCount;++i){var bytedata=value&255;if(neg){bytedata=~bytedata&255}this.data[this.index++]=bytedata;value/=256}};ByteWriteStream.prototype.writeInt8=function(value){this.writeInt(1,value)};ByteWriteStream.prototype.writeInt16=function(value){this.writeInt(2,value)};ByteWriteStream.prototype.writeInt32=function(value){this.writeInt(4,value)};ByteWriteStream.prototype.writeInt64=function(value){this.writeInt(8,value)};ByteWriteStream.prototype.writeBool=function(value){this.writeInt(1,value?1:0)};ByteWriteStream.prototype.writeString=function(value){var encoded_buffer_view=new TextEncoder("utf-8").encode(value);if(encoded_buffer_view.length>=Math.pow(2,32)){throw new Error("String too long!")}this.writeUint(4,encoded_buffer_view.length);this.reserve(encoded_buffer_view.length);for(var i=0;i<encoded_buffer_view.length;++i){this.data[this.index++]=encoded_buffer_view[i]}};ByteWriteStream.prototype.getBuffer=function(){var ret_buffer=new ArrayBuffer(this.index);var ret_data=new Uint8Array(ret_buffer);for(var i=0;i<this.index;++i){ret_data[i]=this.data[i]}return ret_buffer};var Point=function(x,y){if(x instanceof Point){this.x=x.x;this.y=x.y;return}this.x=x||0;this.y=y||0};Point.fromStream=function(stream){if(stream instanceof TokenStream)return new Point(parseInt(stream.read(),10),parseInt(stream.read(),10));if(stream instanceof ByteReadStream)return new Point(stream.readInt32(),stream.readInt32());throw new Error("Invalid stream!")};Point.average=function(pt1,pt2){return new Point((pt1.x+pt2.x)/2,(pt1.y+pt2.y)/2)};Point.weightedAverage=function(pt1,weight1,pt2,weight2){return new Point((pt1.x*weight1+pt2.x*weight2)/(weight1+weight2),(pt1.y*weight1+pt2.y*weight2)/(weight1+weight2))};Point.prototype.angleFrom=function(pt){return Math.atan2(this.y-pt.y,this.x-pt.x)};Point.prototype.angleTo=function(pt){return pt.angleFrom(this)};Point.prototype.squareDistanceFrom=Point.prototype.squareDistanceTo=function(pt){var dx=this.x-pt.x;var dy=this.y-pt.y;return dx*dx+dy*dy};Point.prototype.distanceFrom=Point.prototype.distanceTo=function(pt){return Math.sqrt(this.squareDistanceTo(pt))};Point.prototype.translate=function(pt){return new Point(this.x+pt.x,this.y+pt.y)};Point.prototype.translateByDirection=function(angle,distance){return new Point(this.x+Math.cos(angle)*distance,this.y+Math.sin(angle)*distance)};var Agent=function(location,mass,health,is_boosting,has_shield){this.location=location||new Point(0,0);this.mass=mass||0;this.health=health||Agent.MAX_HEALTH;this.is_boosting=!!is_boosting;this.has_shield=!!has_shield};Agent.fromStream=function(stream){if(stream instanceof TokenStream)return new Agent(Point.fromStream(stream),parseInt(stream.read(),10),parseInt(stream.read(),10),!!parseInt(stream.read(),10),!!parseInt(stream.read(),10));if(stream instanceof ByteReadStream)return new Agent(Point.fromStream(stream),stream.readInt64(),stream.readInt32(),stream.readBool(),stream.readBool());throw new Error("Invalid stream!")};Agent.MAX_HEALTH=10;var AgentProperties=function(display_name){this.display_name=display_name||""};AgentProperties.fromStream=function(stream){if(stream instanceof TokenStream)return new AgentProperties(stream.read());if(stream instanceof ByteReadStream)return new AgentProperties(stream.readString());throw new Error("Invalid stream!")};var Food=function(location,is_projectile){this.location=location||new Point(0,0);this.is_projectile=!!is_projectile};Food.fromStream=function(stream){if(stream instanceof TokenStream)return new Food(Point.fromStream(stream),parseInt(stream.read(),10));if(stream instanceof ByteReadStream)return new Food(Point.fromStream(stream),stream.readBool());throw new Error("Invalid stream!")};var Projectile=function(location,angle){this.location=location||new Point(0,0);this.angle=angle||0};Projectile.fromStream=function(stream){if(stream instanceof TokenStream)return new Projectile(Point.fromStream(stream),parseFloat(stream.read()));throw new Error("Invalid stream!")};var wraparound_average=function(a,b,mod){if(b<a){var tmp=a;a=b;b=tmp}if(Math.abs(b-a)<Math.abs(a+mod-b)){return(a+b)/2}else{return(a+mod+b)/2%mod}};var InterpolationDelayEngine=function(weightedAverager,cloner){this.weightedAverager=weightedAverager;this.cloner=cloner||function(x){return x};this.prevLocation=undefined;this.currLocation=undefined;this.lastRetrievedLocation=undefined;this.prevTime=undefined;this.currTime=undefined;this.lastRetrievedTime=undefined};InterpolationDelayEngine.prototype.set=function(pt,time){time=time||(new Date).getTime();if(this.lastRetrievedTime&&this.lastRetrievedTime<=time){this.prevLocation=this.lastRetrievedLocation||this.cloner(pt);this.prevTime=this.lastRetrievedTime||time;this.currLocation=this.cloner(pt);this.currTime=time}else{this.prevLocation=this.currLocation||this.cloner(pt);this.prevTime=this.currTime||time;this.currLocation=this.cloner(pt);this.currTime=time}};InterpolationDelayEngine.prototype.get=function(time){time=time||(new Date).getTime();this.lastRetrievedLocation=this.weightedAverager(this.currLocation,time-this.prevTime,this.prevLocation,this.currTime-time);this.lastRetrievedTime=time;return this.cloner(this.lastRetrievedLocation)};var InterpolatorMap=function(interpolationEngineCreator,weightedAverager,cloner){this.interpolationEngineCreator=interpolationEngineCreator;this.weightedAverager=weightedAverager;this.cloner=cloner;this.map=new Map};InterpolatorMap.prototype.getData=function(time){if(!time)console.log("c2");time=time||(new Date).getTime();var ret=new Map;this.map.forEach(function(val,key){ret.set(key,val.get(time))});return ret};InterpolatorMap.prototype.get=function(key,time){if(!time)console.log("c1");time=time||(new Date).getTime();var val=this.map.get(key);return val!==undefined?val.get(time):undefined};InterpolatorMap.prototype.forEach=function(callback,time){if(!time)console.log("c3");time=time||(new Date).getTime();var that=this;this.map.forEach(function(val,key){callback(val.get(time),key,that)})};InterpolatorMap.prototype.setData=function(dataMap,time){if(!time)console.log("c4");time=time||(new Date).getTime();var prevMap=this.map;this.map=new Map;var that=this;dataMap.forEach(function(val,key){var prevVal=prevMap.get(key);if(prevVal===undefined)prevVal=that.interpolationEngineCreator(that.weightedAverager,that.cloner);prevVal.set(val,time);that.map.set(key,prevVal)})};InterpolatorMap.prototype.set=function(key,val,time){if(!time)console.log("c5");time=time||(new Date).getTime();if(!this.map.has(key)){this.map.set(key,this.interpolationEngineCreator(this.weightedAverager,this.cloner))}this.map.get(key).set(val,time)};InterpolatorMap.prototype.forEachEngine=function(callback){var that=this;this.map.forEach(function(val,key){callback(val,key,that)})};var ChangeLimitedDelayEngine=function(calculator,cloner){this.calculator=calculator;this.cloner=cloner||function(x){return x};this.lastRetrievedLocation=undefined;this.targetLocation=undefined;this.lastRetrievedTime=undefined};ChangeLimitedDelayEngine.prototype.set=function(pt){this.targetLocation=this.cloner(pt);if(!this.lastRetrievedLocation)this.lastRetrievedLocation=this.targetLocation};ChangeLimitedDelayEngine.prototype.get=function(time){time=time||(new Date).getTime();if(!this.targetLocation)return undefined;if(!this.lastRetrievedTime){this.lastRetrievedTime=time;return this.cloner(this.targetLocation)}if(this.lastRetrievedLocation===this.targetLocation){this.lastRetrievedTime=time;return this.cloner(this.targetLocation)}if(this.lastRetrievedLocation===undefined)console.log("assert");this.lastRetrievedLocation=this.calculator(this.lastRetrievedLocation,this.targetLocation,time-this.lastRetrievedTime);this.lastRetrievedTime=time;return this.cloner(this.lastRetrievedLocation)};(function(i,s,o,g,r,a,m){i["GoogleAnalyticsObject"]=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date;a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,"script","https://www.google-analytics.com/analytics.js","ga");ga("create","UA-91309626-1","auto");ga("send","pageview");var DomGame=function(canvas,options,death_callback){var canvas_scale=Math.sqrt(canvas.width*canvas.height);var resize_handler=function(){canvas_device_pixel_scale=window.devicePixelRatio||1;logical_width=canvas.offsetWidth;logical_height=canvas.offsetHeight;canvas.width=logical_width*canvas_device_pixel_scale;canvas.height=logical_height*canvas_device_pixel_scale;canvas_scale=Math.sqrt(logical_width*logical_height);send_dimensions_to_server()};var mousemove_handler=function(e){process_movement_dir_update(new Point(e.clientX,e.clientY))};var override_actions=false;var mousedown_handler=function(e){if(!override_actions){if(e.button===0)process_firing_update(new Point(e.clientX,e.clientY),true);if(e.button===2)process_boosting_update(true)}};var mouseup_handler=function(e){if(!override_actions){if(e.button===0)process_firing_update(new Point(e.clientX,e.clientY),false);if(e.button===2)process_boosting_update(false)}else{if(death_callback){death_callback();death_callback=undefined}setTimeout(function(){socket.close()},1e3)}};var mouseout_handler=function(e){if(!override_actions){process_firing_update(new Point(e.clientX,e.clientY),false);process_boosting_update(false)}};var touchbuttonradius=48;var is_boost_button=function(pt){var boost_centre=new Point(options.opposite?24+touchbuttonradius:logical_width-touchbuttonradius-24,logical_height-touchbuttonradius-24);return boost_centre.distanceTo(pt)<=touchbuttonradius};var is_fire_button=function(pt){var fire_centre=new Point(options.opposite?logical_width-touchbuttonradius-24:24+touchbuttonradius,logical_height-touchbuttonradius-24);return fire_centre.distanceTo(pt)<=touchbuttonradius};var lastMovementDirTouchStartTime=0;var boostMovementTouchRunning=false;var ongoingMovementDirTouchID,ongoingFiringTouchID,ongoingBoostingTouchID;var movement_pt=new Point(logical_width/2,logical_height/2);var touchstart_handler=function(e){var movementTouch=Array.prototype.find.call(e.changedTouches,function(touch){var pt=new Point(touch.clientX,touch.clientY);return!is_boost_button(pt)&&!is_fire_button(pt)});if(movementTouch){ongoingMovementDirTouchID=movementTouch.identifier;movement_pt=new Point(movementTouch.clientX,movementTouch.clientY);process_movement_dir_update(movement_pt);var nowTime=Date.now();if(lastMovementDirTouchStartTime+300>nowTime){process_boosting_update(true);boostMovementTouchRunning=true}lastMovementDirTouchStartTime=nowTime}var boostingTouch=Array.prototype.find.call(e.changedTouches,function(touch){var pt=new Point(touch.clientX,touch.clientY);return is_boost_button(pt)});if(boostingTouch){ongoingBoostingTouchID=boostingTouch.identifier;process_boosting_update(true)}var firingTouch=Array.prototype.find.call(e.changedTouches,function(touch){var pt=new Point(touch.clientX,touch.clientY);return is_fire_button(pt)});if(firingTouch){ongoingFiringTouchID=firingTouch.identifier;process_firing_update(movement_pt,true)}};var touchend_handler=function(e){if(ongoingMovementDirTouchID!==undefined){var movementTouch=Array.prototype.find.call(e.changedTouches,function(touch){return touch.identifier===ongoingMovementDirTouchID});if(movementTouch){ongoingMovementDirTouchID=undefined;if(boostMovementTouchRunning){if(ongoingBoostingTouchID===undefined)process_boosting_update(false);boostMovementTouchRunning=false}}}if(ongoingBoostingTouchID!==undefined){var boostingTouch=Array.prototype.find.call(e.changedTouches,function(touch){return touch.identifier===ongoingBoostingTouchID});if(boostingTouch){ongoingBoostingTouchID=undefined;if(!boostMovementTouchRunning)process_boosting_update(false)}}if(ongoingFiringTouchID!==undefined){var firingTouch=Array.prototype.find.call(e.changedTouches,function(touch){return touch.identifier===ongoingFiringTouchID});if(firingTouch){ongoingFiringTouchID=undefined;process_firing_update(movement_pt,false)}}};var touchcancel_handler=function(e){touchend_handler(e)};var touchmove_handler=function(e){if(ongoingMovementDirTouchID!==undefined){var movementTouch=Array.prototype.find.call(e.changedTouches,function(touch){return touch.identifier===ongoingMovementDirTouchID});if(movementTouch){movement_pt=new Point(movementTouch.clientX,movementTouch.clientY);process_movement_dir_update(movement_pt)}}};var keydown_handler=function(e){if(!override_actions){switch(e.key){case" ":case"Spacebar":process_boosting_update(true);break}}};var keyup_handler=function(e){if(!override_actions){switch(e.key){case" ":case"Spacebar":process_boosting_update(false);break}}};var client_area=new ChangeLimitedDelayEngine(function(prev_area,target_area,time_diff){if(prev_area===target_area)return target_area;if(time_diff<0)console.log("invalid!");var multiplier=1.00001;if(prev_area<target_area){curr_area=Math.pow(Math.sqrt(prev_area)*Math.pow(multiplier,time_diff),2);return curr_area>=target_area?target_area:curr_area}else{curr_area=Math.pow(Math.sqrt(prev_area)*Math.pow(multiplier,-time_diff),2);return curr_area<=target_area?target_area:curr_area}},function(area){return area});var height,width;var agents=new InterpolatorMap(function(weightedAverager,cloner){return new InterpolationDelayEngine(weightedAverager,cloner)},function(agent1,weight1,agent2,weight2){if(Math.abs(weight1+weight2)<.1){return new Agent(agent1.location,agent1.mass,agent1.health,agent2.is_boosting,agent2.has_shield)}var location=Point.weightedAverage(agent1.location,weight1,agent2.location,weight2);var mass=(agent1.mass*weight1+agent2.mass*weight2)/(weight1+weight2);var health=(agent1.health*weight1+agent2.health*weight2)/(weight1+weight2);var is_boosting=agent2.is_boosting;var has_shield=agent2.has_shield;return new Agent(location,mass,health,is_boosting,has_shield)},function(agent){return new Agent(agent.location,agent.mass,agent.health,agent.is_boosting,agent.has_shield)});var agent_properties=new Map;var foods=new InterpolatorMap(function(weightedAverager,cloner){return new InterpolationDelayEngine(weightedAverager,cloner)},function(food1,weight1,food2,weight2){if(Math.abs(weight1+weight2)<.1){return new Food(food1.location,food1.is_projectile)}var location=Point.weightedAverage(food1.location,weight1,food2.location,weight2);var is_projectile=food1.is_projectile&&food2.is_projectile;return new Food(location,is_projectile)},function(food){return new Food(food.location,food.is_projectile)});var current_agent_boost_streams=new Map;var agent_boost_streams=[];var agent_shields=new Map;var food_update_cache=new Map;var leaderboard=[];var centre_loc=new InterpolationDelayEngine(function(loc1,weight1,loc2,weight2){if(Math.abs(weight1+weight2)<.1){return new Point(loc1.x,loc1.y)}return Point.weightedAverage(loc1,weight1,loc2,weight2)},function(loc){return new Point(loc.x,loc.y)});var is_alive=false;var my_agentid=undefined;var current_movement_dir=null;var current_firing=false;var current_boosting=false;var message_period=100;var displayTime=undefined;var socket;var canvas;var food_radius=100;var boost_animation_period=1e3;var canvas_device_pixel_scale=1;var logical_width,logical_height;var anim_request=undefined;this._start=function(remote_endpoint,display_name){window.addEventListener("resize",resize_handler);resize_handler();if(!options.touch){canvas.addEventListener("mousemove",mousemove_handler);canvas.addEventListener("mousedown",mousedown_handler);canvas.addEventListener("mouseup",mouseup_handler);canvas.addEventListener("mouseout",mouseout_handler);window.addEventListener("keydown",keydown_handler);window.addEventListener("keyup",keyup_handler)}else{canvas.addEventListener("touchmove",touchmove_handler);canvas.addEventListener("touchstart",touchstart_handler);canvas.addEventListener("touchend",touchend_handler);canvas.addEventListener("touchcancel",touchcancel_handler)}canvas.addEventListener("contextmenu",function(e){e.preventDefault();return false});var ctx=canvas.getContext("2d",{alpha:false});var draw_handler=function(){ctx.save();var real_height=logical_height;var real_width=logical_width;canvas_scale=Math.sqrt(real_height*real_width);ctx.scale(canvas_scale*canvas_device_pixel_scale,canvas_scale*canvas_device_pixel_scale);height=real_height/canvas_scale;width=real_width/canvas_scale;draw(ctx);ctx.restore();anim_request=window.requestAnimationFrame(draw_handler)};try{socket=new WebSocket("ws://"+remote_endpoint);socket.binaryType="arraybuffer";socket.addEventListener("open",function(){spawn_me_on_server(display_name);send_dimensions_to_server();anim_request=window.requestAnimationFrame(draw_handler)});socket.addEventListener("error",function(e){console.log(e.message)});socket.addEventListener("message",function(e){process_message(e.data)});socket.addEventListener("close",function(e){console.log("Connection terminated. (Code: "+e.code+", reason: "+e.reason+")")});ctx.mozImageSmoothingEnabled=false;ctx.webkitImageSmoothingEnabled=false;ctx.msImageSmoothingEnabled=false;ctx.imageSmoothingEnabled=false;ctx.fillStyle="black";ctx.fillRect(0,0,width,height)}catch(e){console.log(e.message)}};this._stop=function(){if(socket)socket.close();socket=undefined;window.cancelAnimationFrame(anim_request);if(!options.touch){window.removeEventListener("keyup",keyup_handler);window.removeEventListener("keydown",keydown_handler);canvas.removeEventListener("mouseout",mouseout_handler);canvas.removeEventListener("mouseup",mouseup_handler);canvas.removeEventListener("mousedown",mousedown_handler)}else{canvas.removeEventListener("touchcancel",touchcancel_handler);canvas.removeEventListener("touchend",touchend_handler);canvas.removeEventListener("touchstart",touchstart_handler);canvas.removeEventListener("touchmove",touchmove_handler)}window.removeEventListener("resize",resize_handler)};var getFittingText=function(ctx,text,maxWidth){var width=ctx.measureText(text).width;if(width<=maxWidth)return text;var ellipsis="";var best=ellipsis;for(var i=1;i<text.length;++i){var str=text.substr(0,i)+ellipsis;if(ctx.measureText(str).width<=maxWidth){best=str}else{break}}return best};var prerendered_boost_button_canvas;var prerendered_fire_button_canvas;var draw=function(ctx){if(!centre_loc.currTime)return;ctx.fillStyle="black";ctx.fillRect(0,0,width,height);ctx.save();displayTime=(new Date).getTime()-message_period;var _curr_area=client_area.get(displayTime);if(!_curr_area)_curr_area=3e5*Math.sqrt(1e5);var server_size_factor=Math.sqrt(_curr_area);var current_centre=centre_loc.get(displayTime);if(current_centre)ctx.translate(width/2-current_centre.x/server_size_factor,height/2-current_centre.y/server_size_factor);ctx.scale(1/server_size_factor,1/server_size_factor);var left=current_centre?current_centre.x-width/2*server_size_factor:0;var top=current_centre?current_centre.y-height/2*server_size_factor:0;ctx.lineCap="butt";ctx.lineWidth=2*server_size_factor/canvas_scale;ctx.strokeStyle="#333";for(var x=Math.ceil(left/1e3)*1e3;x<=left+width*server_size_factor;x+=1e3){ctx.beginPath();ctx.moveTo(x,top);ctx.lineTo(x,top+height*server_size_factor);ctx.stroke()}for(var y=Math.ceil(top/1e3)*1e3;y<=top+height*server_size_factor;y+=1e3){ctx.beginPath();ctx.moveTo(left,y);ctx.lineTo(left+width*server_size_factor,y);ctx.stroke()}agent_boost_streams=agent_boost_streams.filter(function(agent_boost_stream){var endlength=Math.ceil((2e3-(displayTime-agent_boost_stream.updated_time))/100);if(endlength<=0){return false}if(endlength<agent_boost_stream.data.length)agent_boost_stream.data=agent_boost_stream.data.slice(0,endlength);if(agent_boost_stream.data.length<=1)return true;agent_boost_stream.offset.forEach(function(offset){var offset_boost_stream=agent_boost_stream.data.map(function(pt,index,arr){var ang_next,ang_prev;if(index>0){ang_prev=pt.angleFrom(arr[index-1])}if(index<arr.length-1){ang_next=pt.angleTo(arr[index+1])}var ang_avg;if(index===0){ang_avg=ang_next}else if(index===arr.length-1){ang_avg=ang_prev}else{ang_avg=wraparound_average(ang_prev,ang_next,Math.PI*2)}ang_avg+=Math.PI/2;return pt.translateByDirection(ang_avg,(1-Math.pow(Math.min((displayTime-agent_boost_stream.updated_time+(index+1)*100)/2e3,1),4))*agent_boost_stream.width*Math.sin(offset+(agent_boost_stream.updated_time-index*100)/boost_animation_period*2*Math.PI))});offset_boost_stream.forEach(function(pt,index,arr){if(displayTime-agent_boost_stream.updated_time+index*100>=0&&index>0&&index<arr.length-1){ctx.lineCap="butt";ctx.lineWidth=20;var ax=(arr[index-1].x+pt.x)/2;var ay=(arr[index-1].y+pt.y)/2;var bx=(arr[index+1].x+pt.x)/2;var by=(arr[index+1].y+pt.y)/2;var linearGradient=ctx.createLinearGradient(ax,ay,bx,by);linearGradient.addColorStop(0,"rgba(255,255,255,"+(.5-.5*(displayTime-agent_boost_stream.updated_time+index*100)/2e3)+")");linearGradient.addColorStop(1,"rgba(255,255,255,"+Math.max(.5-.5*(displayTime-agent_boost_stream.updated_time+(index+1)*100)/2e3,0)+")");ctx.strokeStyle=linearGradient;ctx.beginPath();ctx.moveTo(ax,ay);ctx.quadraticCurveTo(pt.x,pt.y,bx,by);ctx.stroke()}})});return true});foods.forEach(function(food){var food_gradient=ctx.createRadialGradient(food.location.x,food.location.y,food_radius*4/8,food.location.x,food.location.y,food_radius*11/8);if(!food.is_projectile){food_gradient.addColorStop(0,"rgba(255,255,128,1)");food_gradient.addColorStop(.33,"rgba(255,255,128,0.7)");food_gradient.addColorStop(.67,"rgba(255,255,128,0.3)");food_gradient.addColorStop(1,"rgba(255,255,128,0)")}else{food_gradient.addColorStop(0,"rgba(255,170,128,1)");food_gradient.addColorStop(.33,"rgba(255,170,128,0.7)");food_gradient.addColorStop(.67,"rgba(255,170,128,0.3)");food_gradient.addColorStop(1,"rgba(255,170,128,0)")}ctx.fillStyle=food_gradient;ctx.beginPath();ctx.arc(food.location.x,food.location.y,food_radius*11/8,-Math.PI,Math.PI);ctx.closePath();ctx.fill()},displayTime);agents.forEach(function(agent){var outer_radius=Math.sqrt(agent.mass)+agent.health*12;var player_gradient=ctx.createRadialGradient(agent.location.x,agent.location.y,Math.sqrt(agent.mass),agent.location.x,agent.location.y,outer_radius);player_gradient.addColorStop(0,"rgba(224,255,255,1)");player_gradient.addColorStop(.33,"rgba(224,255,255,0.7)");player_gradient.addColorStop(.67,"rgba(224,255,255,0.3)");player_gradient.addColorStop(1,"rgba(224,255,255,0)");ctx.fillStyle=player_gradient;ctx.beginPath();ctx.arc(agent.location.x,agent.location.y,outer_radius,-Math.PI,Math.PI);ctx.closePath();ctx.fill()},displayTime);ctx.save();ctx.textAlign="center";ctx.textBaseline="middle";if(hasGlobalCompositeOperationDifference){ctx.globalCompositeOperation="difference";ctx.fillStyle="white"}else{ctx.fillStyle="grey"}agents.forEach(function(agent,agentid){var font_size=Math.pow(agent.mass,1/4)*8;ctx.font=font_size+"px CandelaBold,sans-serif";var display_name=agent_properties.get(agentid).display_name;ctx.fillText(display_name,agent.location.x,agent.location.y)},displayTime);ctx.restore();ctx.save();agent_shields.forEach(function(agent_shield,agentid){var agent=agents.get(agentid,displayTime);if(agent){var agent_radius=Math.sqrt(agent.mass);var shield_radius=agent_radius+Math.sqrt(agent.mass);if(agent_shield.fade_start_time){if(displayTime>agent_shield.fade_start_time){if(displayTime>=agent_shield.fade_start_time+1e3){agent_shields.delete(agentid);return}else{ctx.globalAlpha=(agent_shield.fade_start_time+1e3-displayTime)/1e3}}else{ctx.globalAlpha=1}}else{ctx.globalAlpha=1}var shield_gradient=ctx.createRadialGradient(agent.location.x,agent.location.y,shield_radius-200,agent.location.x,agent.location.y,shield_radius+20);shield_gradient.addColorStop(0/11,"rgba(255,255,255,0)");shield_gradient.addColorStop(4/11,"rgba(255,255,255,0.1)");shield_gradient.addColorStop(7/11,"rgba(255,255,255,0.25)");shield_gradient.addColorStop(10/11,"rgba(255,255,255,0.5)");shield_gradient.addColorStop(11/11,"rgba(255,255,255,0)");ctx.fillStyle=shield_gradient;ctx.beginPath();ctx.arc(agent.location.x,agent.location.y,shield_radius+15,-Math.PI,Math.PI);ctx.closePath();ctx.fill()}else{agent_shields.delete(agentid)}});ctx.restore();ctx.restore();ctx.save();ctx.translate(width,0);ctx.scale(1/(32*Math.sqrt(canvas_scale)),1/(32*Math.sqrt(canvas_scale)));ctx.translate(-8,8);ctx.font="14px CandelaBold,sans-serif";if(hasGlobalCompositeOperationDifference){ctx.globalCompositeOperation="difference";ctx.fillStyle="white"}else{ctx.fillStyle="grey"}ctx.textBaseline="top";for(var i=0;i<leaderboard.length;++i){var score_width=ctx.measureText(leaderboard[i].score.toString()).width;ctx.textAlign="left";var calculatedName=getFittingText(ctx,leaderboard[i].display_name,192-score_width-4);ctx.fillText(calculatedName,-192,i*20);ctx.textAlign="right";ctx.fillText(leaderboard[i].score.toString(),0,i*20)}ctx.restore();if(options.touch){ctx.save();ctx.scale(1/canvas_scale,1/canvas_scale);ctx.save();if(!options.opposite){ctx.translate(logical_width-96-24-12,logical_height-96-24-12)}else{ctx.translate(12,logical_height-96-24-12)}if(!prerendered_boost_button_canvas){prerendered_boost_button_canvas=document.createElement("canvas");prerendered_boost_button_canvas.width=(96+24)*canvas_device_pixel_scale;prerendered_boost_button_canvas.height=(96+24)*canvas_device_pixel_scale;var prerender_ctx=prerendered_boost_button_canvas.getContext("2d");prerender_ctx.scale(canvas_device_pixel_scale,canvas_device_pixel_scale);prerender_ctx.translate(48+12,48+12);var button_background_gradient=prerender_ctx.createRadialGradient(0,0,48,0,0,48+12);button_background_gradient.addColorStop(0,"rgba(0,0,0,0.5)");button_background_gradient.addColorStop(1,"rgba(0,0,0,0)");prerender_ctx.fillStyle=button_background_gradient;prerender_ctx.beginPath();prerender_ctx.arc(0,0,48+12,-Math.PI,Math.PI);prerender_ctx.closePath();prerender_ctx.fill();var boost_angle=-30*Math.PI/180;var button_border_gradient=prerender_ctx.createRadialGradient(0,0,36,0,0,48);button_border_gradient.addColorStop(0,"rgba(255,255,255,0)");button_border_gradient.addColorStop(.4,"rgba(255,255,255,0.1)");button_border_gradient.addColorStop(.7,"rgba(255,255,255,0.25)");button_border_gradient.addColorStop(1,"rgba(255,255,255,0.5)");prerender_ctx.fillStyle=button_border_gradient;prerender_ctx.beginPath();prerender_ctx.arc(0,0,48,-Math.PI,Math.PI);prerender_ctx.closePath();prerender_ctx.fill();prerender_ctx.translate(24*Math.cos(boost_angle),24*Math.sin(boost_angle));var button_boost_locpoints=[];for(var index=0;index<=16;++index){var translate_dist=index*4;var pt_x=-Math.cos(boost_angle)*translate_dist;var pt_y=-Math.sin(boost_angle)*translate_dist;button_boost_locpoints.push(new Point(pt_x,pt_y))}var button_boost_keypoints=[];var button_num_boost_streams=3;var boost_offset_angle=boost_angle+Math.PI/2;for(var i=0;i<button_num_boost_streams;++i){var this_boost_keypoints=[];button_boost_locpoints.forEach(function(pt,index){
var disp=(1-Math.pow(index/16,4))*12*Math.sin(index+Math.PI*2/button_num_boost_streams*i);var pt_x=pt.x+Math.cos(boost_offset_angle)*disp;var pt_y=pt.y+Math.sin(boost_offset_angle)*disp;this_boost_keypoints.push(new Point(pt_x,pt_y))});button_boost_keypoints.push(this_boost_keypoints)}button_boost_keypoints.forEach(function(keystream){keystream.forEach(function(pt,index,arr){if(index>=1&&index<arr.length-1){prerender_ctx.lineCap="butt";prerender_ctx.lineWidth=2;var ax=(arr[index-1].x+pt.x)/2;var ay=(arr[index-1].y+pt.y)/2;var bx=(arr[index+1].x+pt.x)/2;var by=(arr[index+1].y+pt.y)/2;var boost_linearGradient=prerender_ctx.createLinearGradient(ax,ay,bx,by);boost_linearGradient.addColorStop(0,"rgba(255,255,255,"+(1-(index-.5)/16)/2+")");boost_linearGradient.addColorStop(1,"rgba(255,255,255,"+(1-(index+.5)/16)/2+")");prerender_ctx.strokeStyle=boost_linearGradient;prerender_ctx.beginPath();prerender_ctx.moveTo(ax,ay);prerender_ctx.quadraticCurveTo(pt.x,pt.y,bx,by);prerender_ctx.stroke()}})});var button_agent_hole_gradient=prerender_ctx.createRadialGradient(0,0,12,0,0,18);button_agent_hole_gradient.addColorStop(0,"rgba(255,255,255,1)");button_agent_hole_gradient.addColorStop(.33,"rgba(255,255,255,0.7)");button_agent_hole_gradient.addColorStop(.67,"rgba(255,255,255,0.3)");button_agent_hole_gradient.addColorStop(1,"rgba(255,255,255,0)");prerender_ctx.fillStyle=button_agent_hole_gradient;prerender_ctx.globalCompositeOperation="destination-out";prerender_ctx.beginPath();prerender_ctx.arc(0,0,18,-Math.PI,Math.PI);prerender_ctx.closePath();prerender_ctx.fill();var button_agent_gradient=prerender_ctx.createRadialGradient(0,0,12,0,0,18);button_agent_gradient.addColorStop(0,"rgba(255,255,255,0.5)");button_agent_gradient.addColorStop(.33,"rgba(255,255,255,0.35)");button_agent_gradient.addColorStop(.67,"rgba(255,255,255,0.15)");button_agent_gradient.addColorStop(1,"rgba(255,255,255,0)");prerender_ctx.fillStyle=button_agent_gradient;prerender_ctx.globalCompositeOperation="source-over";prerender_ctx.beginPath();prerender_ctx.arc(0,0,18,-Math.PI,Math.PI);prerender_ctx.closePath();prerender_ctx.fill()}ctx.drawImage(prerendered_boost_button_canvas,0,0,96+24,96+24);ctx.restore();ctx.save();if(!options.opposite){ctx.translate(12,logical_height-96-24-12)}else{ctx.translate(logical_width-96-24-12,logical_height-96-24-12)}if(!prerendered_fire_button_canvas){prerendered_fire_button_canvas=document.createElement("canvas");prerendered_fire_button_canvas.width=(96+24)*canvas_device_pixel_scale;prerendered_fire_button_canvas.height=(96+24)*canvas_device_pixel_scale;var prerender_ctx=prerendered_fire_button_canvas.getContext("2d");prerender_ctx.scale(canvas_device_pixel_scale,canvas_device_pixel_scale);prerender_ctx.translate(48+12,48+12);var button_background_gradient=prerender_ctx.createRadialGradient(0,0,48,0,0,48+12);button_background_gradient.addColorStop(0,"rgba(0,0,0,0.5)");button_background_gradient.addColorStop(1,"rgba(0,0,0,0)");prerender_ctx.fillStyle=button_background_gradient;prerender_ctx.beginPath();prerender_ctx.arc(0,0,48+12,-Math.PI,Math.PI);prerender_ctx.closePath();prerender_ctx.fill();var boost_angle=-30*Math.PI/180;var button_border_gradient=prerender_ctx.createRadialGradient(0,0,36,0,0,48);button_border_gradient.addColorStop(0,"rgba(255,255,255,0)");button_border_gradient.addColorStop(.4,"rgba(255,255,255,0.1)");button_border_gradient.addColorStop(.7,"rgba(255,255,255,0.25)");button_border_gradient.addColorStop(1,"rgba(255,255,255,0.5)");prerender_ctx.fillStyle=button_border_gradient;prerender_ctx.beginPath();prerender_ctx.arc(0,0,48,-Math.PI,Math.PI);prerender_ctx.closePath();prerender_ctx.fill();prerender_ctx.translate(-24*Math.cos(boost_angle),-24*Math.sin(boost_angle));var button_agent_gradient=prerender_ctx.createRadialGradient(0,0,12,0,0,18);button_agent_gradient.addColorStop(0,"rgba(255,255,255,0.5)");button_agent_gradient.addColorStop(.33,"rgba(255,255,255,0.35)");button_agent_gradient.addColorStop(.67,"rgba(255,255,255,0.15)");button_agent_gradient.addColorStop(1,"rgba(255,255,255,0)");prerender_ctx.fillStyle=button_agent_gradient;prerender_ctx.beginPath();prerender_ctx.arc(0,0,18,-Math.PI,Math.PI);prerender_ctx.closePath();prerender_ctx.fill();prerender_ctx.rotate(boost_angle);var button_projectile_gradient=prerender_ctx.createRadialGradient(48,0,6,48,0,9);button_projectile_gradient.addColorStop(0,"rgba(255,255,255,0.5)");button_projectile_gradient.addColorStop(.33,"rgba(255,255,255,0.35)");button_projectile_gradient.addColorStop(.67,"rgba(255,255,255,0.15)");button_projectile_gradient.addColorStop(1,"rgba(255,255,255,0)");prerender_ctx.fillStyle=button_projectile_gradient;prerender_ctx.beginPath();prerender_ctx.arc(48,0,9,-Math.PI,Math.PI);prerender_ctx.closePath();prerender_ctx.fill();prerender_ctx.lineWidth=2;prerender_ctx.lineCap="round";var stroke_gradient;stroke_gradient=prerender_ctx.createLinearGradient(20,0,37,0);stroke_gradient.addColorStop(0,"rgba(255,255,255,0.2)");stroke_gradient.addColorStop(1,"rgba(255,255,255,0.5)");prerender_ctx.strokeStyle=stroke_gradient;prerender_ctx.beginPath();prerender_ctx.moveTo(20,0);prerender_ctx.lineTo(37,0);prerender_ctx.stroke();stroke_gradient=prerender_ctx.createLinearGradient(28,4.5,38.5,4.5);stroke_gradient.addColorStop(0,"rgba(255,255,255,0.2)");stroke_gradient.addColorStop(1,"rgba(255,255,255,0.5)");prerender_ctx.strokeStyle=stroke_gradient;prerender_ctx.beginPath();prerender_ctx.moveTo(28,4.5);prerender_ctx.lineTo(38.5,4.5);prerender_ctx.stroke();stroke_gradient=prerender_ctx.createLinearGradient(28,-4.5,38.5,-4.5);stroke_gradient.addColorStop(0,"rgba(255,255,255,0.2)");stroke_gradient.addColorStop(1,"rgba(255,255,255,0.5)");prerender_ctx.strokeStyle=stroke_gradient;prerender_ctx.beginPath();prerender_ctx.moveTo(28,-4.5);prerender_ctx.lineTo(38.5,-4.5);prerender_ctx.stroke();stroke_gradient=prerender_ctx.createLinearGradient(12,1,24,8);stroke_gradient.addColorStop(0,"rgba(255,255,255,0)");stroke_gradient.addColorStop(1,"rgba(255,255,255,0.5)");prerender_ctx.strokeStyle=stroke_gradient;prerender_ctx.beginPath();prerender_ctx.moveTo(12,1);prerender_ctx.lineTo(24,8);prerender_ctx.stroke();stroke_gradient=prerender_ctx.createLinearGradient(12,-1,24,-8);stroke_gradient.addColorStop(0,"rgba(255,255,255,0)");stroke_gradient.addColorStop(1,"rgba(255,255,255,0.5)");prerender_ctx.strokeStyle=stroke_gradient;prerender_ctx.beginPath();prerender_ctx.moveTo(12,-1);prerender_ctx.lineTo(24,-8);prerender_ctx.stroke()}ctx.drawImage(prerendered_fire_button_canvas,0,0,96+24,96+24);ctx.restore();ctx.restore()}};var message_time_storage=[];var last_message_curr_location=undefined;var boardsize=new Point(8e4,8e4);var process_message=function(data){try{var stream=new ByteReadStream(data);var msgtype=stream.readUint8();switch(msgtype){case 1:process_field_update(stream);break;case 2:process_death(stream);break;case 3:process_leaderboard_update(stream);break}}catch(e){console.log(e.message)}};var process_field_update=function(stream){var new_agents=new Map;var new_foods=new Map;var timestamp=stream.readUint64();var clienttime=(new Date).getTime();message_time_storage.push(clienttime-timestamp);if(message_time_storage.length>50)message_time_storage.shift();var avg_delay=message_time_storage.reduce(function(sum,el){return sum+el},0)/message_time_storage.length;var calculatedtime=timestamp+avg_delay;var screen_centre=Point.fromStream(stream);var screen_dimensions=Point.fromStream(stream);my_agentid=stream.readUint64()+"";if(my_agentid!=="0"){is_alive=true}else{my_agentid=undefined}var agent_ct=stream.readUint32();var updated_foods_ct=stream.readUint32();var removed_foods_ct=stream.readUint32();for(var i=0;i<agent_ct;++i){var agentid=stream.readUint64()+"";var new_agent=Agent.fromStream(stream);new_agents.set(agentid,new_agent);if(!agent_properties.has(agentid)){var new_agent_properties=AgentProperties.fromStream(stream);agent_properties.set(agentid,new_agent_properties)}}for(var i=0;i<updated_foods_ct;++i){var foodid=stream.readUint64()+"";var new_food=Food.fromStream(stream);new_foods.set(foodid,new_food);food_update_cache.delete(foodid)}for(var i=0;i<removed_foods_ct;++i){var foodid=stream.readUint64()+"";food_update_cache.delete(foodid)}food_update_cache.forEach(function(new_food,foodid){new_foods.set(foodid,new_food)});food_update_cache.clear();new_foods.forEach(function(new_food,foodid){food_update_cache.set(foodid,new Food(new_food.location,new_food.is_projectile))});var curr_message_curr_location=screen_centre;if(last_message_curr_location&&last_message_curr_location.x-curr_message_curr_location.x>boardsize.x/2){[agents,foods].forEach(function(interpolatorMap){interpolatorMap.forEachEngine(function(engine){if(engine.lastRetrievedLocation)engine.lastRetrievedLocation.location=new Point(engine.lastRetrievedLocation.location.x-boardsize.x,engine.lastRetrievedLocation.location.y);if(engine.currLocation)engine.currLocation.location=new Point(engine.currLocation.location.x-boardsize.x,engine.currLocation.location.y);if(engine.prevLocation)engine.prevLocation.location=new Point(engine.prevLocation.location.x-boardsize.x,engine.prevLocation.location.y)})});agent_boost_streams.forEach(function(agent_boost_stream){agent_boost_stream.data.forEach(function(pt){pt.x-=boardsize.x})});if(centre_loc.lastRetrievedLocation)centre_loc.lastRetrievedLocation=new Point(centre_loc.lastRetrievedLocation.x-boardsize.x,centre_loc.lastRetrievedLocation.y);if(centre_loc.currLocation)centre_loc.currLocation=new Point(centre_loc.currLocation.x-boardsize.x,centre_loc.currLocation.y);if(centre_loc.prevLocation)centre_loc.prevLocation=new Point(centre_loc.prevLocation.x-boardsize.x,centre_loc.prevLocation.y)}else if(last_message_curr_location&&curr_message_curr_location.x-last_message_curr_location.x>boardsize.x/2){[agents,foods].forEach(function(interpolatorMap){interpolatorMap.forEachEngine(function(engine){if(engine.lastRetrievedLocation)engine.lastRetrievedLocation.location=new Point(engine.lastRetrievedLocation.location.x+boardsize.x,engine.lastRetrievedLocation.location.y);if(engine.currLocation)engine.currLocation.location=new Point(engine.currLocation.location.x+boardsize.x,engine.currLocation.location.y);if(engine.prevLocation)engine.prevLocation.location=new Point(engine.prevLocation.location.x+boardsize.x,engine.prevLocation.location.y)})});agent_boost_streams.forEach(function(agent_boost_stream){agent_boost_stream.data.forEach(function(pt){pt.x+=boardsize.x})});if(centre_loc.lastRetrievedLocation)centre_loc.lastRetrievedLocation=new Point(centre_loc.lastRetrievedLocation.x+boardsize.x,centre_loc.lastRetrievedLocation.y);if(centre_loc.currLocation)centre_loc.currLocation=new Point(centre_loc.currLocation.x+boardsize.x,centre_loc.currLocation.y);if(centre_loc.prevLocation)centre_loc.prevLocation=new Point(centre_loc.prevLocation.x+boardsize.x,centre_loc.prevLocation.y)}if(last_message_curr_location&&last_message_curr_location.y-curr_message_curr_location.y>boardsize.y/2){[agents,foods].forEach(function(interpolatorMap){interpolatorMap.forEachEngine(function(engine){if(engine.lastRetrievedLocation)engine.lastRetrievedLocation.location=new Point(engine.lastRetrievedLocation.location.x,engine.lastRetrievedLocation.location.y-boardsize.y);if(engine.currLocation)engine.currLocation.location=new Point(engine.currLocation.location.x,engine.currLocation.location.y-boardsize.y);if(engine.prevLocation)engine.prevLocation.location=new Point(engine.prevLocation.location.x,engine.prevLocation.location.y-boardsize.y)})});agent_boost_streams.forEach(function(agent_boost_stream){agent_boost_stream.data.forEach(function(pt){pt.y-=boardsize.y})});if(centre_loc.lastRetrievedLocation)centre_loc.lastRetrievedLocation=new Point(centre_loc.lastRetrievedLocation.x,centre_loc.lastRetrievedLocation.y-boardsize.y);if(centre_loc.currLocation)centre_loc.currLocation=new Point(centre_loc.currLocation.x,centre_loc.currLocation.y-boardsize.y);if(centre_loc.prevLocation)centre_loc.prevLocation=new Point(centre_loc.prevLocation.x,centre_loc.prevLocation.y-boardsize.y)}else if(last_message_curr_location&&curr_message_curr_location.y-last_message_curr_location.y>boardsize.y/2){[agents,foods].forEach(function(interpolatorMap){interpolatorMap.forEachEngine(function(engine){if(engine.lastRetrievedLocation)engine.lastRetrievedLocation.location=new Point(engine.lastRetrievedLocation.location.x,engine.lastRetrievedLocation.location.y+boardsize.y);if(engine.currLocation)engine.currLocation.location=new Point(engine.currLocation.location.x,engine.currLocation.location.y+boardsize.y);if(engine.prevLocation)engine.prevLocation.location=new Point(engine.prevLocation.location.x,engine.prevLocation.location.y+boardsize.y)})});agent_boost_streams.forEach(function(agent_boost_stream){agent_boost_stream.data.forEach(function(pt){pt.y+=boardsize.y})});if(centre_loc.lastRetrievedLocation)centre_loc.lastRetrievedLocation=new Point(centre_loc.lastRetrievedLocation.x,centre_loc.lastRetrievedLocation.y+boardsize.y);if(centre_loc.currLocation)centre_loc.currLocation=new Point(centre_loc.currLocation.x,centre_loc.currLocation.y+boardsize.y);if(centre_loc.prevLocation)centre_loc.prevLocation=new Point(centre_loc.prevLocation.x,centre_loc.prevLocation.y+boardsize.y)}var new_current_agent_boost_streams=new Map;new_agents.forEach(function(agent,agentid){if(agent.is_boosting){var agent_boost_stream=current_agent_boost_streams.get(agentid);if(!agent_boost_stream){agent_boost_stream={updated_time:calculatedtime,offset:[],data:[],width:Math.sqrt(agent.mass)/1.5};for(var j=0;j<Math.sqrt(agent.mass)/150;++j){agent_boost_stream.offset.push(Math.random()*2*Math.PI)}agent_boost_streams.push(agent_boost_stream)}agent_boost_stream.updated_time=calculatedtime;agent_boost_stream.offset=agent_boost_stream.offset.map(function(offset){return(offset+boost_animation_period/message_period*2*Math.PI)%(2*Math.PI)});agent_boost_stream.data.unshift(new Point(agent.location));new_current_agent_boost_streams.set(agentid,agent_boost_stream)}});current_agent_boost_streams=new_current_agent_boost_streams;new_agents.forEach(function(agent,agentid){if(agent.has_shield){agent_shields.set(agentid,{fade_start_time:undefined})}else{var agent_shield=agent_shields.get(agentid);if(agent_shield&&!agent_shield.fade_start_time){agent_shield.fade_start_time=calculatedtime}}});last_message_curr_location=curr_message_curr_location;agents.setData(new_agents,calculatedtime);foods.setData(new_foods,calculatedtime);centre_loc.set(screen_centre,calculatedtime);client_area.set(screen_dimensions.x*screen_dimensions.y)};var process_death=function(stream){is_alive=false;my_agentid=undefined;override_actions=true;setTimeout(function(){if(death_callback){death_callback();death_callback=undefined}setTimeout(function(){socket.close()},1e3)},4e3)};var process_leaderboard_update=function(stream){var leaderboard_ct=stream.readUint8();leaderboard=[];for(var i=0;i<leaderboard_ct;++i){var curr_display_name=stream.readString();var curr_score=stream.readInt64();leaderboard.push({display_name:curr_display_name,score:curr_score})}};var spawn_me_on_server=function(display_name){if(socket.readyState===1){var stream=new ByteWriteStream;stream.writeUint8(3);stream.writeString(display_name);socket.send(stream.getBuffer())}};var send_dimensions_to_server=function(){if(socket&&socket.readyState===1){var stream=new ByteWriteStream;stream.writeUint8(2);stream.writeUint32(logical_width);stream.writeUint32(logical_height);socket.send(stream.getBuffer())}};var send_update_to_server=function(){if(socket.readyState===1&&is_alive){var stream=new ByteWriteStream;stream.writeUint8(1);stream.writeBool(current_movement_dir!==null);stream.writeBool(current_firing);if(current_movement_dir!==null){stream.writeBool(current_boosting);stream.writeInt16(Math.round(current_movement_dir*(360*60/(2*Math.PI))))}socket.send(stream.getBuffer())}};var process_movement_dir_update=function(pt){if(is_alive&&displayTime){var current_mouse_pos=pt;var centerpoint=new Point(logical_width/2,logical_height/2);if(current_mouse_pos.distanceFrom(centerpoint)<Math.sqrt(agents.get(my_agentid,displayTime).mass)/Math.sqrt(client_area.get(displayTime))*canvas_scale){current_movement_dir=null}else{current_movement_dir=current_mouse_pos.angleFrom(centerpoint)}send_update_to_server()}};var process_firing_update=function(pt,state){if(current_firing!==state){current_firing=state;send_update_to_server()}};var process_boosting_update=function(state){if(current_boosting!==state){current_boosting=state;send_update_to_server()}}};DomGame.prototype.start=function(remote_endpoint,display_name){this._start(remote_endpoint,display_name)};DomGame.prototype.stop=function(){this._stop()};var fontsloaded=false;var fontsloadedcallbacks=[];var hasGlobalCompositeOperationDifference=true;window.addEventListener("load",function(){var canvas=document.getElementById("main-canvas");var death_callback=function(){game_started=false;document.getElementById("welcome-panel").classList.remove("hidden");name_textbox.focus()};var dom_game;var game_started=false;var name_textbox=document.getElementById("name-textbox");var chosen_endpoint;var found_best=function(){};var xhr=new XMLHttpRequest;xhr.addEventListener("load",function(e){var remote_endpoint_list=JSON.parse(xhr.responseText);var endpoint_count;var remote_endpoint_list_with_latency=[];var ended_wait=false;var too_long=false;var remote_endpoint_callback=function(){if(!ended_wait){if(too_long||remote_endpoint_list_with_latency.length==endpoint_count){ended_wait=true;var best_endpoint;var best_val=1e4;remote_endpoint_list_with_latency.forEach(function(li){if(li.latency<best_val){best_val=li.latency;best_endpoint=li.endpoint}});if(best_endpoint){chosen_endpoint=best_endpoint;found_best()}}}};endpoint_count=Object.keys(remote_endpoint_list).length;Object.keys(remote_endpoint_list).forEach(function(geographical_location){var remote_endpoint=remote_endpoint_list[geographical_location];var re_xhr=new XMLHttpRequest;var time_start=Date.now();re_xhr.addEventListener("load",function(e){remote_endpoint_list_with_latency.push({endpoint:remote_endpoint,latency:Date.now()-time_start});remote_endpoint_callback()});re_xhr.open("GET","http://"+remote_endpoint+"/");re_xhr.send()});setTimeout(function(){too_long=true;remote_endpoint_callback()},3e3)});xhr.open("GET","http://lobby.celestia.io:8080/welcome");xhr.send();window.addEventListener("keydown",function(e){switch(e.key){case"Enter":var start_game_handler=function(){if(!game_started){game_started=true;name_textbox.blur();if(dom_game)dom_game.stop();var do_start=function(){ga("send","event","game","start");var options={touch:document.getElementsByClassName("visible")[0].classList.contains("touch"),opposite:document.getElementsByClassName("visible")[0].classList.contains("opposite"),hasGlobalCompositeOperationDifference:hasGlobalCompositeOperationDifference};dom_game=new DomGame(canvas,options,death_callback);dom_game.start(chosen_endpoint,name_textbox.value);document.getElementById("welcome-panel").classList.add("hidden")};if(chosen_endpoint){do_start()}else{found_best=function(){found_best=function(){};do_start()}}}};if(fontsloaded){start_game_handler()}else{fontsloadedcallbacks.push(start_game_handler)}e.preventDefault();break}});var title_flexitem=document.getElementById("flex-item-title");var canvas_clipper=document.getElementById("canvas-clipper");var title_canvas=document.getElementById("title-canvas");var title_ctx=title_canvas.getContext("2d");var canvas_device_pixel_scale=window.devicePixelRatio||1;var title_logical_width;var title_logical_height;var drawing_width=600;var drawing_height=drawing_width/3;var baseline_height=150;var additional_padding=200;var prerender_canvas_done=false;var resize_handler=function(){title_flexitem.style.height="200px";title_logical_height=Math.min(title_flexitem.offsetHeight,drawing_height);title_logical_width=Math.min(title_flexitem.offsetWidth,title_logical_height*drawing_width/drawing_height);title_logical_height=Math.ceil(title_logical_width*drawing_height/drawing_width);canvas_clipper.style.width=title_logical_width+"px";canvas_clipper.style.height=title_logical_height+"px";title_flexitem.style.height=title_logical_height+"px";title_canvas.style.width=title_logical_width+additional_padding*2+"px";title_canvas.style.height=title_logical_height+additional_padding*2+"px";title_canvas.style.left=-additional_padding+"px";title_canvas.style.top=-additional_padding+"px";title_canvas.width=(title_logical_width+additional_padding*2)*canvas_device_pixel_scale;title_canvas.height=(title_logical_height+additional_padding*2)*canvas_device_pixel_scale;prerender_canvas_done=false};window.addEventListener("resize",resize_handler);resize_handler();var title_animrequest_id;var get_title_random_color=function(){return[128,255,255]};var to_canvas_color=function(color_arr){return"rgb("+Math.round(color_arr[0]).toString()+","+Math.round(color_arr[1]).toString()+","+Math.round(color_arr[2]).toString()+")"};var to_canvas_color_with_alpha=function(color_arr){return"rgba("+Math.round(color_arr[0]).toString()+","+Math.round(color_arr[1]).toString()+","+Math.round(color_arr[2]).toString()+","+color_arr[3].toString()+")"};var restart_title_animation=function(){if(title_animrequest_id)window.cancelAnimationFrame(title_animrequest_id);var time_start=Date.now();var text_name="celestia";var addn_name=".io";var text_parts=[];var colors=[];for(var i=0;i<text_name.length;++i){colors.push(get_title_random_color());text_parts.push(text_name.charAt(i))}colors.push(get_title_random_color());text_parts.push(addn_name);var prerender_canvas=document.createElement("canvas");var draw=function(){title_ctx.save();title_ctx.clearRect(0,0,(title_logical_width+additional_padding*2)*canvas_device_pixel_scale,(title_logical_height+additional_padding*2)*canvas_device_pixel_scale);title_ctx.translate(additional_padding*canvas_device_pixel_scale,additional_padding*canvas_device_pixel_scale);title_ctx.scale(title_logical_width/drawing_width*canvas_device_pixel_scale,title_logical_width/drawing_width*canvas_device_pixel_scale);title_ctx.textAlign="left";title_ctx.textBaseline="alphabetic";title_ctx.font="168px CandelaBold,sans-serif";var time_offset=Date.now()-time_start;var text_width=title_ctx.measureText(text_name).width;var offset_hide=Math.max(drawing_width,drawing_height)+additional_padding*drawing_width/title_logical_width;var shadowOffsetX=offset_hide*title_logical_width/drawing_width*canvas_device_pixel_scale;var shadowOffsetY=offset_hide*title_logical_width/drawing_width*canvas_device_pixel_scale;for(var i=0;i<text_parts.length;++i){title_ctx.font=i<text_name.length?"168px CandelaBold,sans-serif":"40px CandelaBold,sans-serif";var char_offset_left=i<text_name.length?text_width-title_ctx.measureText(text_name.substr(i)).width+(drawing_width-text_width)/2:(drawing_width+text_width)/2;var local_time_offset=time_offset-i*100;if(i===6&&(!prerender_canvas_done||local_time_offset>1e3)){prerender_canvas.width=title_canvas.width;prerender_canvas.height=title_canvas.height;var prerender_ctx=prerender_canvas.getContext("2d");prerender_ctx.save();prerender_ctx.clearRect(0,0,(title_logical_width+additional_padding*2)*canvas_device_pixel_scale,(title_logical_height+additional_padding*2)*canvas_device_pixel_scale);prerender_ctx.translate(additional_padding*canvas_device_pixel_scale,additional_padding*canvas_device_pixel_scale);prerender_ctx.scale(title_logical_width/drawing_width*canvas_device_pixel_scale,title_logical_width/drawing_width*canvas_device_pixel_scale);prerender_ctx.textAlign="left";prerender_ctx.textBaseline="alphabetic";prerender_ctx.font="168px CandelaBold,sans-serif";if(local_time_offset<=1e3){prerender_ctx.fillStyle=to_canvas_color(colors[i])}else if(local_time_offset<2e3){var fraction=(local_time_offset-1e3)/1e3;var this_color=to_canvas_color([colors[i][0]*(1-fraction)+255*fraction,colors[i][1]*(1-fraction)+255*fraction,colors[i][2]*(1-fraction)+255*fraction]);prerender_ctx.fillStyle=this_color}else{prerender_ctx.fillStyle="white"}prerender_ctx.fillText(text_parts[i],char_offset_left,baseline_height);prerender_ctx.globalCompositeOperation="destination-out";prerender_ctx.fillStyle="black";prerender_ctx.beginPath();prerender_ctx.arc(462,49,12,-Math.PI,Math.PI);prerender_ctx.closePath();prerender_ctx.fill();prerender_ctx.restore();prerender_canvas_done=true}title_ctx.save();var offset_hide=Math.max(drawing_width,drawing_height)+additional_padding*drawing_width/title_logical_width;title_ctx.shadowOffsetX=shadowOffsetX;title_ctx.shadowOffsetY=shadowOffsetY;if(local_time_offset<=0){}else if(local_time_offset<=1e3){title_ctx.globalAlpha=local_time_offset/1e3;var this_color=to_canvas_color(colors[i]);title_ctx.shadowBlur=20+(1e3-local_time_offset)/8;title_ctx.shadowColor=this_color;if(i!==6)title_ctx.fillText(text_parts[i],char_offset_left-offset_hide,baseline_height-offset_hide);else title_ctx.drawImage(prerender_canvas,-additional_padding*drawing_width/title_logical_width-offset_hide,-additional_padding*drawing_width/title_logical_width-offset_hide,drawing_width+additional_padding*drawing_width/title_logical_width*2,drawing_height+additional_padding*drawing_width/title_logical_width*2)}else if(local_time_offset<2e3){var fraction=(local_time_offset-1e3)/1e3;var this_color=to_canvas_color([colors[i][0]*(1-fraction)+255*fraction,colors[i][1]*(1-fraction)+255*fraction,colors[i][2]*(1-fraction)+255*fraction]);title_ctx.shadowBlur=20;title_ctx.shadowColor=this_color;if(i!==6)title_ctx.fillText(text_parts[i],char_offset_left-offset_hide,baseline_height-offset_hide);else title_ctx.drawImage(prerender_canvas,-additional_padding*drawing_width/title_logical_width-offset_hide,-additional_padding*drawing_width/title_logical_width-offset_hide,drawing_width+additional_padding*drawing_width/title_logical_width*2,drawing_height+additional_padding*drawing_width/title_logical_width*2)}else{title_ctx.shadowBlur=20;title_ctx.shadowColor="white";if(i!==6)title_ctx.fillText(text_parts[i],char_offset_left-offset_hide,baseline_height-offset_hide);else title_ctx.drawImage(prerender_canvas,-additional_padding*drawing_width/title_logical_width-offset_hide,-additional_padding*drawing_width/title_logical_width-offset_hide,drawing_width+additional_padding*drawing_width/title_logical_width*2,drawing_height+additional_padding*drawing_width/title_logical_width*2)}title_ctx.restore();title_ctx.save();if(local_time_offset<=0){}else if(local_time_offset<=1e3){title_ctx.globalAlpha=local_time_offset/1e3;var this_color=to_canvas_color(colors[i]);title_ctx.shadowOffsetX=shadowOffsetX;title_ctx.shadowOffsetY=shadowOffsetY;title_ctx.shadowBlur=(1e3-local_time_offset)/8;title_ctx.shadowColor=this_color;if(i!==6)title_ctx.fillText(text_parts[i],char_offset_left-offset_hide,baseline_height-offset_hide);else title_ctx.drawImage(prerender_canvas,-additional_padding*drawing_width/title_logical_width-offset_hide,-additional_padding*drawing_width/title_logical_width-offset_hide,drawing_width+additional_padding*drawing_width/title_logical_width*2,drawing_height+additional_padding*drawing_width/title_logical_width*2)}else if(local_time_offset<2e3){var fraction=(local_time_offset-1e3)/1e3;var this_color=to_canvas_color([colors[i][0]*(1-fraction)+255*fraction,colors[i][1]*(1-fraction)+255*fraction,colors[i][2]*(1-fraction)+255*fraction]);title_ctx.fillStyle=this_color;if(i!==6)title_ctx.fillText(text_parts[i],char_offset_left,baseline_height);else title_ctx.drawImage(prerender_canvas,-additional_padding*drawing_width/title_logical_width,-additional_padding*drawing_width/title_logical_width,drawing_width+additional_padding*drawing_width/title_logical_width*2,drawing_height+additional_padding*drawing_width/title_logical_width*2)}else{title_ctx.fillStyle="white";if(i!==6)title_ctx.fillText(text_parts[i],char_offset_left,baseline_height);else title_ctx.drawImage(prerender_canvas,-additional_padding*drawing_width/title_logical_width,-additional_padding*drawing_width/title_logical_width,drawing_width+additional_padding*drawing_width/title_logical_width*2,drawing_height+additional_padding*drawing_width/title_logical_width*2)}title_ctx.restore()}title_ctx.save();title_ctx.translate(462,49);var star_color=[255,255,128];if(time_offset<=700){}else if(time_offset<2200){var st_radius=100;var st_start=-60*Math.PI/180;var st_end=-30*Math.PI/180;var mid_x=-Math.cos(st_end)*st_radius;var mid_y=-Math.sin(st_end)*st_radius;var fraction=Math.sin((time_offset-700)/(2200-700)*Math.PI/2);var current_angle=st_start*(1-fraction)+st_end*fraction;var curr_x=mid_x+Math.cos(current_angle)*st_radius;var curr_y=mid_y+Math.sin(current_angle)*st_radius;var fraction_linear=(time_offset-700)/(2200-700);if(title_ctx.ellipse){title_ctx.shadowColor=to_canvas_color_with_alpha([star_color[0],star_color[1],star_color[2],Math.min(fraction_linear*2,1)]);title_ctx.shadowOffsetX=shadowOffsetX;title_ctx.shadowOffsetY=shadowOffsetY;title_ctx.shadowBlur=60*fraction_linear;var radius=18*fraction_linear;for(var i=0;i<8;++i){var ecc2=.2;var ecc=Math.sqrt(ecc2);var angle=i*Math.PI/4;var dist=radius*Math.sqrt(1/ecc2-ecc2);title_ctx.beginPath();title_ctx.ellipse(curr_x+Math.cos(angle)*dist-offset_hide,curr_y+Math.sin(angle)*dist-offset_hide,radius/ecc,radius*ecc,angle,-Math.PI,Math.PI);title_ctx.fill()}title_ctx.shadowBlur=30*fraction_linear;title_ctx.beginPath();title_ctx.arc(curr_x-offset_hide,curr_y-offset_hide,24*fraction_linear,-Math.PI,Math.PI);title_ctx.closePath();title_ctx.fill()}else{var st_gradient=title_ctx.createRadialGradient(curr_x,curr_y,0,curr_x,curr_y,fraction_linear*50);st_gradient.addColorStop(0,to_canvas_color_with_alpha([star_color[0],star_color[1],star_color[2],Math.min(fraction_linear*2,1)]));st_gradient.addColorStop(.1,to_canvas_color_with_alpha([star_color[0],star_color[1],star_color[2],Math.min(fraction_linear*2,1)]));st_gradient.addColorStop(.4,to_canvas_color_with_alpha([star_color[0],star_color[1],star_color[2],Math.min(fraction_linear*2,1)*.7]));st_gradient.addColorStop(.7,to_canvas_color_with_alpha([star_color[0],star_color[1],star_color[2],Math.min(fraction_linear*2,1)*.3]));st_gradient.addColorStop(1,to_canvas_color_with_alpha([star_color[0],star_color[1],star_color[2],0]));title_ctx.fillStyle=st_gradient;title_ctx.beginPath();title_ctx.arc(curr_x,curr_y,fraction_linear*50,-Math.PI,Math.PI);title_ctx.closePath();title_ctx.fill()}}else{if(title_ctx.ellipse){title_ctx.shadowColor=to_canvas_color(star_color);title_ctx.shadowOffsetX=shadowOffsetX;title_ctx.shadowOffsetY=shadowOffsetY;title_ctx.shadowBlur=60;var radius=18;for(var i=0;i<8;++i){var ecc2=.2;var ecc=Math.sqrt(ecc2);var angle=i*Math.PI/4;var dist=radius*Math.sqrt(1/ecc2-ecc2);title_ctx.beginPath();title_ctx.ellipse(Math.cos(angle)*dist-offset_hide,Math.sin(angle)*dist-offset_hide,radius/ecc,radius*ecc,angle,-Math.PI,Math.PI);title_ctx.fill()}title_ctx.shadowBlur=30;title_ctx.beginPath();title_ctx.arc(-offset_hide,-offset_hide,24,-Math.PI,Math.PI);title_ctx.closePath();title_ctx.fill()}else{var st_gradient=title_ctx.createRadialGradient(0,0,0,0,0,50);st_gradient.addColorStop(0,to_canvas_color_with_alpha([star_color[0],star_color[1],star_color[2],1]));st_gradient.addColorStop(.1,to_canvas_color_with_alpha([star_color[0],star_color[1],star_color[2],1]));st_gradient.addColorStop(.4,to_canvas_color_with_alpha([star_color[0],star_color[1],star_color[2],.7]));st_gradient.addColorStop(.7,to_canvas_color_with_alpha([star_color[0],star_color[1],star_color[2],.3]));st_gradient.addColorStop(1,to_canvas_color_with_alpha([star_color[0],star_color[1],star_color[2],0]));title_ctx.fillStyle=st_gradient;title_ctx.beginPath();title_ctx.arc(0,0,50,-Math.PI,Math.PI);title_ctx.closePath();title_ctx.fill()}}title_ctx.restore();title_ctx.restore();return time_offset>=Math.max(2200,2e3+(text_parts.length-1)*100)};var handler=function(){if(!draw())title_animrequest_id=window.requestAnimationFrame(handler);else title_animrequest_id=undefined;
};title_animrequest_id=window.requestAnimationFrame(handler);window.addEventListener("resize",function(){if(title_animrequest_id===undefined)setTimeout(draw,0)})};if(fontsloaded){restart_title_animation()}else{fontsloadedcallbacks.push(restart_title_animation)}var interactionmode_el=document.getElementById("interactionmode");var interactionlist=[];Array.prototype.forEach.call(interactionmode_el.childNodes,function(el){if(el.nodeType===1&&el.tagName==="SPAN"&&el.classList.contains("interactionoption")){interactionlist.push(el)}});interactionmode_el.addEventListener("click",function(e){var visibleindex=interactionlist.findIndex(function(el){return el.classList.contains("visible")});interactionlist.forEach(function(el){el.classList.remove("visible")});if(visibleindex!==-1){interactionlist[(visibleindex+1)%interactionlist.length].classList.add("visible")}});var suppress_autodetect=false;var suppress_autodetector=function(e){if(!suppress_autodetect){interactionmode_el.removeEventListener("mousedown",suppress_autodetector);interactionmode_el.removeEventListener("touchstart",suppress_autodetector);window.removeEventListener("mousedown",autodetector);window.removeEventListener("touchstart",autodetector);suppress_autodetect=true}};var autodetector=function(e){if(!suppress_autodetect){if(e.type==="touchstart"){interactionlist.forEach(function(el){el.classList.remove("visible")});document.getElementById("touchdefault").classList.add("visible")}interactionmode_el.removeEventListener("mousedown",suppress_autodetector);interactionmode_el.removeEventListener("touchstart",suppress_autodetector);window.removeEventListener("mousedown",autodetector);window.removeEventListener("touchstart",autodetector);suppress_autodetect=true}};window.addEventListener("touchstart",autodetector);window.addEventListener("mousedown",autodetector);interactionmode_el.addEventListener("touchstart",suppress_autodetector);interactionmode_el.addEventListener("mousedown",suppress_autodetector);var globalCompositeTestCanvas=document.createElement("canvas");globalCompositeTestCanvas.width=1;globalCompositeTestCanvas.height=1;var text_ctx=globalCompositeTestCanvas.getContext("2d");text_ctx.fillStyle="white";text_ctx.fillRect(0,0,1,1);text_ctx.globalCompositeOperation="difference";text_ctx.fillRect(0,0,1,1);if(text_ctx.getImageData(0,0,1,1).data[0]>128){hasGlobalCompositeOperationDifference=false}text_ctx=undefined;globalCompositeTestCanvas=undefined;var textElements=document.getElementById("flex-item-note").getElementsByTagName("span");var nextElementIndex=0;var doDisplayNextNote=function(){var thisEl=textElements[nextElementIndex];thisEl.classList.add("displayed");window.setTimeout(function(){thisEl.classList.add("opaque");window.setTimeout(function(){thisEl.classList.remove("opaque");window.setTimeout(function(){thisEl.classList.remove("displayed");++nextElementIndex;if(nextElementIndex>=textElements.length){nextElementIndex-=textElements.length}window.setTimeout(doDisplayNextNote,0)},1e3)},3980)},20)};window.setTimeout(doDisplayNextNote,0);var fontLoader=new FontLoader(["CandelaBold:n7"],{complete:function(error){if(error!==null){console.log("Could not load font.")}fontsloaded=true;fontsloadedcallbacks.forEach(function(callback){callback()});fontsloadedcallbacks=[]}},5e3);fontLoader.loadFonts()});window.addEventListener("load",function(){(function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(d.getElementById(id))return;js=d.createElement(s);js.id=id;js.src="//connect.facebook.net/en_US/sdk.js#xfbml=1&version=v2.8";fjs.parentNode.insertBefore(js,fjs)})(document,"script","facebook-jssdk")});window.addEventListener("load",function(){window.twttr=function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],t=window.twttr||{};if(d.getElementById(id))return t;js=d.createElement(s);js.id=id;js.src="https://platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);t._e=[];t.ready=function(f){t._e.push(f)};return t}(document,"script","twitter-wjs")});